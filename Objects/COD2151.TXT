OBJECT Codeunit 2151 O365 Sales Email Management
{
  OBJECT-PROPERTIES
  {
    Date=28.05.17;
    Time=12:00:00;
    Version List=NAVW110.0;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {

    [Internal]
    PROCEDURE ShowEmailDialog@2(DocumentNo@1000 : Code[20]) : Boolean;
    VAR
      SalesInvoiceHeader@1001 : Record 112;
      TempEmailItem@1004 : TEMPORARY Record 9500;
      ReportSelections@1010 : Record 77;
      TempReportSelections@1005 : TEMPORARY Record 77;
      EmailParameter@1003 : Record 9510;
      DocumentMailing@1008 : Codeunit 260;
      O365HTMLTemplMgt@1006 : Codeunit 2114;
      O365SalesEmailDialog@1002 : Page 2150;
      DocumentRecordVariant@1013 : Variant;
      CustomerNo@1014 : Code[20];
      EmailAddress@1007 : Text[250];
      ReportUsage@1009 : Integer;
    BEGIN
      IF NOT InitializeDocumentSpecificVariables(DocumentRecordVariant,ReportUsage,CustomerNo,DocumentNo) THEN
        EXIT;

      IF NOT ReportSelections.GetEmailBody(
           TempEmailItem."Body File Path",ReportUsage,DocumentRecordVariant,CustomerNo,EmailAddress)
      THEN
        ;
      IF ReportSelections.FindEmailAttachmentUsage(ReportUsage,CustomerNo,TempReportSelections) THEN BEGIN
        // Create attachment
        TempReportSelections.GetPdfReport(
          TempEmailItem."Attachment File Path",ReportUsage,
          DocumentRecordVariant,CustomerNo);

        DocumentMailing.GetAttachmentFileName(
          TempEmailItem."Attachment Name",
          DocumentNo,
          SalesInvoiceHeader.GetDefaultEmailDocumentName,
          ReportUsage);
      END;

      TempEmailItem.Subject := DocumentMailing.GetEmailSubject(DocumentNo,SalesInvoiceHeader.GetDefaultEmailDocumentName,ReportUsage);
      TempEmailItem."Send to" := EmailAddress;
      TempEmailItem.AddCcBcc;
      TempEmailItem.AttachIncomingDocuments(DocumentNo);
      TempEmailItem.INSERT(TRUE);
      COMMIT;

      O365SalesEmailDialog.SetValues(DocumentRecordVariant,TempEmailItem);
      IF O365SalesEmailDialog.RUNMODAL = ACTION::OK THEN BEGIN
        O365SalesEmailDialog.GETRECORD(TempEmailItem);
        IF EmailAddress <> TempEmailItem."Send to" THEN
          O365HTMLTemplMgt.ReplaceBodyFileSendTo(
            TempEmailItem."Body File Path",EmailAddress,TempEmailItem."Send to");

        SetEmailOnDocument(DocumentNo,TempEmailItem."Send to");
        EmailParameter.SaveParameterValueWithReportUsage(
          DocumentNo,ReportUsage,EmailParameter."Parameter Type"::Subject,TempEmailItem.Subject);
        EXIT(TRUE);
      END;
      O365SalesEmailDialog.GETRECORD(TempEmailItem);
      EmailParameter.SaveParameterValueWithReportUsage(
        DocumentNo,ReportUsage,EmailParameter."Parameter Type"::Subject,TempEmailItem.Subject);
    END;

    LOCAL PROCEDURE InitializeDocumentSpecificVariables@12(VAR DocumentRecordVariant@1001 : Variant;VAR ReportUsage@1005 : Integer;VAR CustomerNo@1000 : Code[20];DocumentNo@1002 : Code[20]) : Boolean;
    VAR
      SalesInvoiceHeader@1003 : Record 112;
      SalesHeader@1004 : Record 36;
      ReportSelections@1006 : Record 77;
    BEGIN
      IF SalesInvoiceHeader.GET(DocumentNo) THEN BEGIN
        SalesInvoiceHeader.SETRECFILTER;
        DocumentRecordVariant := SalesInvoiceHeader;
        CustomerNo := SalesInvoiceHeader."Bill-to Customer No.";
        ReportUsage := ReportSelections.Usage::"S.Invoice";
        EXIT(TRUE);
      END;

      SalesHeader.SETFILTER("Document Type",'%1|%2',SalesHeader."Document Type"::Quote,SalesHeader."Document Type"::Invoice);
      SalesHeader.SETRANGE("No.",DocumentNo);
      IF SalesHeader.FINDFIRST THEN BEGIN
        SalesHeader.SETRECFILTER;
        DocumentRecordVariant := SalesHeader;
        CustomerNo := SalesHeader."Bill-to Customer No.";
        IF SalesHeader."Document Type" = SalesHeader."Document Type"::Invoice THEN
          ReportUsage := ReportSelections.Usage::"S.Invoice Draft"
        ELSE
          ReportUsage := ReportSelections.Usage::"S.Quote";
        EXIT(TRUE);
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE SetEmailOnDocument@3(DocumentNo@1000 : Code[20];SendTo@1001 : Text[250]);
    VAR
      SalesHeader@1002 : Record 36;
      SalesInvoiceHeader@1003 : Record 112;
      Customer@1005 : Record 18;
      SellToCustomerNo@1004 : Code[20];
    BEGIN
      IF SalesInvoiceHeader.GET(DocumentNo) THEN
        SellToCustomerNo := SalesInvoiceHeader."Sell-to Customer No."
      ELSE BEGIN
        SalesHeader.SETFILTER("Document Type",'%1|%2',SalesHeader."Document Type"::Quote,SalesHeader."Document Type"::Invoice);
        SalesHeader.SETRANGE("No.",DocumentNo);
        IF SalesHeader.FINDFIRST THEN
          SellToCustomerNo := SalesHeader."Sell-to Customer No."
        ELSE
          EXIT;
      END;

      IF Customer.GET(SellToCustomerNo) AND (Customer."E-Mail" <> SendTo) THEN BEGIN
        Customer.VALIDATE("E-Mail",COPYSTR(SendTo,1,MAXSTRLEN(Customer."E-Mail")));
        Customer.MODIFY(TRUE);
      END;
    END;

    BEGIN
    END.
  }
}

