OBJECT Codeunit 130410 Sys. Warmup Test Runner
{
  OBJECT-PROPERTIES
  {
    Date=28.05.17;
    Time=12:00:00;
    Version List=NAVW110.0;
  }
  PROPERTIES
  {
    Subtype=TestRunner;
    TestIsolation=Codeunit;
    OnRun=BEGIN
            CODEUNIT.RUN(CODEUNIT::"Sys. Warmup Scenarios");
          END;

  }
  CODE
  {

    [EventSubscriber(Codeunit,1,OnAfterCompanyOpen,"",Skip,Skip)]
    LOCAL PROCEDURE WarmUpOnAfterCompanyOpen@1();
    VAR
      O365GettingStarted@1001 : Record 1309;
      CompanyInformationMgt@1002 : Codeunit 1306;
      PermissionManager@1003 : Codeunit 9002;
    BEGIN
      IF NOT GUIALLOWED THEN
        EXIT;

      IF NOT CompanyInformationMgt.IsDemoCompany THEN
        EXIT;

      IF NOT PermissionManager.SoftwareAsAService THEN
        EXIT;

      IF NOT O365GettingStarted.ISEMPTY THEN
        EXIT;

      IF NOT IsFirstLogon THEN
        EXIT;

      TASKSCHEDULER.CREATETASK(CODEUNIT::"Sys. Warmup Test Runner",0,TRUE,COMPANYNAME,CURRENTDATETIME + 10000); // Add 10s
    END;

    LOCAL PROCEDURE IsFirstLogon@2() : Boolean;
    VAR
      SessionEvent@1000 : Record 2000000111;
      ActiveSession@1001 : Record 2000000110;
    BEGIN
      ActiveSession.GET(SERVICEINSTANCEID,SESSIONID);
      SessionEvent.SETRANGE("Database Name",ActiveSession."Database Name");
      SessionEvent.SETRANGE("Event Type",SessionEvent."Event Type"::Logon);
      SessionEvent.SETFILTER("Client Type",'%1|%2|%3|%4|%5',
        SessionEvent."Client Type"::Desktop,
        SessionEvent."Client Type"::Phone,
        SessionEvent."Client Type"::Tablet,
        SessionEvent."Client Type"::"Web Client",
        SessionEvent."Client Type"::"Windows Client");
      SessionEvent.SETFILTER("Session Unique ID",'<>%1',ActiveSession."Session Unique ID");
      EXIT(SessionEvent.ISEMPTY);
    END;

    BEGIN
    END.
  }
}

