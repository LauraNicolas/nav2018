OBJECT Codeunit 1798 Data Migration Mgt.
{
  OBJECT-PROPERTIES
  {
    Date=06.10.17;
    Time=12:00:00;
    Version List=NAVW111.0;
  }
  PROPERTIES
  {
    TableNo=472;
    OnRun=VAR
            DataMigrationError@1002 : Record 1797;
            DataMigrationStatus@1000 : Record 1799;
            Retry@1001 : Boolean;
          BEGIN
            OnBeforeMigrationStarted;
            DataMigrationStatus.GET("Record ID to Process");
            DataMigrationStatus.SETRANGE("Migration Type",DataMigrationStatus."Migration Type");
            Retry := "Parameter String" = RetryTxt;

            // migrate GL accounts (delete the existing ones on a first migration and if GL accounts are migrated)
            DataMigrationStatus.SETRANGE("Destination Table ID",DATABASE::"G/L Account");
            IF DataMigrationStatus.FINDFIRST AND NOT Retry THEN
              IF NOT CODEUNIT.RUN(CODEUNIT::"Data Migration Del G/L Account") THEN
                DataMigrationError.CreateEntryNoStagingTable(DataMigrationStatus."Migration Type",DATABASE::"G/L Account");

            IF CheckAbortRequestedAndMigrateEntity(
                 DataMigrationStatus,DATABASE::"G/L Account",CODEUNIT::"GL Acc. Data Migration Facade",Retry)
            THEN
              EXIT;

            // migrate customers
            IF CheckAbortRequestedAndMigrateEntity(DataMigrationStatus,DATABASE::Customer,CODEUNIT::"Customer Data Migration Facade",Retry) THEN
              EXIT;

            // migrate vendor
            IF CheckAbortRequestedAndMigrateEntity(DataMigrationStatus,DATABASE::Vendor,CODEUNIT::"Vendor Data Migration Facade",Retry) THEN
              EXIT;

            // migrate items
            CheckAbortRequestedAndMigrateEntity(DataMigrationStatus,DATABASE::Item,CODEUNIT::"Item Data Migration Facade",Retry);

            OnAfterMigrationFinished(DataMigrationStatus,FALSE,StartTime);
          END;

  }
  CODE
  {
    VAR
      DataMigrationStatusFacade@1000 : Codeunit 6101;
      AbortRequested@1001 : Boolean;
      StartTime@1002 : DateTime;
      RetryTxt@1003 : TextConst '@@@={Locked};ENU=Retry';
      DataMigrationNotCompletedErr@1005 : TextConst '@@@=%1 is the caption for Data Migration Overview;ENU=A data migration is already in process. To see the status of the migration, go to the %1 page.';
      CustomerTableNotEmptyErr@1004 : TextConst 'ENU=The migration has stopped because we found some customers in Dynamics 365. You must delete them and then restart the migration.';
      ItemTableNotEmptyErr@1006 : TextConst 'ENU=The migration has stopped because we found some items in Dynamics 365. You must delete them and then restart the migration.';
      VendorTableNotEmptyErr@1007 : TextConst 'ENU=The migration has stopped because we found some vendors in Dynamics 365. You must delete them and then restart the migration.';

    LOCAL PROCEDURE HandleEntityMigration@25(VAR DataMigrationStatus@1003 : Record 1799;BaseAppMigrationCodeunitToRun@1000 : Integer;Retry@1004 : Boolean);
    VAR
      DataMigrationError@1001 : Record 1797;
      MigrationStatus@1005 : 'Pending,In Progress,Completed,Completed with Errors';
    BEGIN
      IF DataMigrationStatus.FINDFIRST THEN
        IF DataMigrationStatus."Source Staging Table ID" > 0 THEN
          StagingTableEntityMigration(DataMigrationStatus,BaseAppMigrationCodeunitToRun,Retry)
        ELSE BEGIN
          DataMigrationStatusFacade.UpdateLineStatus(DataMigrationStatus."Migration Type",
            DataMigrationStatus."Destination Table ID",MigrationStatus::"In Progress");
          DataMigrationError.ClearEntryNoStagingTable(DataMigrationStatus."Migration Type",
            DataMigrationStatus."Destination Table ID");
          COMMIT; // save the dashboard before calling the extension codeunit
          IF CODEUNIT.RUN(DataMigrationStatus."Migration Codeunit To Run") THEN
            DataMigrationStatusFacade.UpdateLineStatus(
              DataMigrationStatus."Migration Type",DataMigrationStatus."Destination Table ID",MigrationStatus::Completed)
          ELSE BEGIN
            DataMigrationError.CreateEntryNoStagingTable(DataMigrationStatus."Migration Type",
              DataMigrationStatus."Destination Table ID");
            DataMigrationStatusFacade.UpdateLineStatus(
              DataMigrationStatus."Migration Type",
              DataMigrationStatus."Destination Table ID",
              MigrationStatus::"Completed with Errors");
          END;
        END;
    END;

    LOCAL PROCEDURE StagingTableEntityMigration@39(DataMigrationStatus@1003 : Record 1799;BaseAppCodeunitToRun@1000 : Integer;Retry@1008 : Boolean);
    VAR
      TempDataMigrationParametersBatch@1004 : TEMPORARY Record 1798;
      DummyDataMigrationStatus@1005 : Record 1799;
      DataMigrationError@1006 : Record 1797;
      StagingTableRecRef@1002 : RecordRef;
      Count@1001 : Integer;
    BEGIN
      StagingTableRecRef.OPEN(DataMigrationStatus."Source Staging Table ID");
      IF StagingTableRecRef.FINDSET THEN BEGIN
        DataMigrationStatusFacade.UpdateLineStatus(DataMigrationStatus."Migration Type",
          DataMigrationStatus."Destination Table ID",DummyDataMigrationStatus.Status::"In Progress");
        REPEAT
          IF AbortRequested THEN
            EXIT;

          DataMigrationError.RESET;
          IF NOT Retry OR
             (Retry AND
              DataMigrationError.FindEntry(DataMigrationStatus."Migration Type",
                DataMigrationStatus."Destination Table ID",StagingTableRecRef.RECORDID) AND
              DataMigrationError."Scheduled For Retry" = TRUE)
          THEN BEGIN
            Count += 1;

            TempDataMigrationParametersBatch.INIT;
            TempDataMigrationParametersBatch.Key := Count;
            TempDataMigrationParametersBatch."Migration Type" := DataMigrationStatus."Migration Type";
            TempDataMigrationParametersBatch."Staging Table Migr. Codeunit" := DataMigrationStatus."Migration Codeunit To Run";
            TempDataMigrationParametersBatch."Staging Table RecId To Process" := StagingTableRecRef.RECORDID;
            TempDataMigrationParametersBatch.INSERT;

            DataMigrationError.ClearEntry(DataMigrationStatus."Migration Type",
              DataMigrationStatus."Destination Table ID",
              StagingTableRecRef.RECORDID);
          END;
          IF Count = 100 THEN BEGIN
            // try to process batch
            COMMIT; // to save the transaction that has deleted the errors
            ProcessBatch(DataMigrationStatus,BaseAppCodeunitToRun,TempDataMigrationParametersBatch,Count);
            Count := 0;
            TempDataMigrationParametersBatch.DELETEALL;
          END;
        UNTIL StagingTableRecRef.NEXT = 0;

        IF AbortRequested THEN
          EXIT;

        IF Count > 0 THEN BEGIN
          COMMIT; // to save the transaction that has deleted the errors
          ProcessBatch(DataMigrationStatus,BaseAppCodeunitToRun,TempDataMigrationParametersBatch,Count);
        END;
      END;

      DataMigrationStatus.CALCFIELDS("Error Count");
      IF DataMigrationStatus."Error Count" = 0 THEN
        DataMigrationStatusFacade.UpdateLineStatus(
          DataMigrationStatus."Migration Type",DataMigrationStatus."Destination Table ID",
          DummyDataMigrationStatus.Status::Completed)
      ELSE
        DataMigrationStatusFacade.UpdateLineStatus(
          DataMigrationStatus."Migration Type",DataMigrationStatus."Destination Table ID",
          DummyDataMigrationStatus.Status::"Completed with Errors");
    END;

    LOCAL PROCEDURE ProcessBatch@9(DataMigrationStatus@1007 : Record 1799;BaseAppCodeunitToRun@1000 : Integer;VAR TempDataMigrationParametersBatch@1005 : TEMPORARY Record 1798;Count@1002 : Integer);
    VAR
      TempDataMigrationParametersSingle@1006 : TEMPORARY Record 1798;
      DataMigrationError@1003 : Record 1797;
    BEGIN
      // try to process batch
      IF CODEUNIT.RUN(BaseAppCodeunitToRun,TempDataMigrationParametersBatch) THEN BEGIN
        // the batch was processed fine, update the dashboard
        DataMigrationStatusFacade.IncrementMigratedRecordCount(DataMigrationStatus."Migration Type",
          DataMigrationStatus."Destination Table ID",Count);
        COMMIT; // save the dashboard status before calling the next Codeunit.RUN
      END ELSE BEGIN
        // the batch processing failed
        TempDataMigrationParametersBatch.FINDSET;
        REPEAT
          // process one by one
          TempDataMigrationParametersSingle.DELETEALL;
          TempDataMigrationParametersSingle.INIT;
          TempDataMigrationParametersSingle.TRANSFERFIELDS(TempDataMigrationParametersBatch);
          TempDataMigrationParametersSingle.INSERT;

          IF CODEUNIT.RUN(BaseAppCodeunitToRun,TempDataMigrationParametersSingle) THEN BEGIN
            // single record processing succeeded, update dashboard
            DataMigrationStatusFacade.IncrementMigratedRecordCount(DataMigrationStatus."Migration Type",
              DataMigrationStatus."Destination Table ID",1);
            COMMIT; // save the dashboard status before calling the next Codeunit.RUN
          END ELSE BEGIN
            DataMigrationError.CreateEntry(DataMigrationStatus."Migration Type",
              DataMigrationStatus."Destination Table ID",TempDataMigrationParametersSingle."Staging Table RecId To Process");
            COMMIT; // save the new errors discovered
          END;
        UNTIL TempDataMigrationParametersBatch.NEXT = 0;
      END;
    END;

    PROCEDURE RunStagingTableMigrationCodeunit@15(CodeunitToRun@1000 : Integer;StagingTableEntityVariant@1001 : Variant) : Boolean;
    BEGIN
      EXIT(CODEUNIT.RUN(CodeunitToRun,StagingTableEntityVariant));
    END;

    [EventSubscriber(Page,1799,OnRequestAbort)]
    LOCAL PROCEDURE OnRequestAbortSubscriber@1();
    BEGIN
      AbortRequested := TRUE;
    END;

    LOCAL PROCEDURE CheckAbortRequestedAndMigrateEntity@5(VAR DataMigrationStatus@1000 : Record 1799;DestinationTableId@1001 : Integer;BaseAppCodeunitToRun@1002 : Integer;ReRun@1003 : Boolean) : Boolean;
    BEGIN
      IF AbortRequested THEN BEGIN
        DataMigrationStatus.RESET;
        DataMigrationStatus.SETRANGE("Migration Type",DataMigrationStatus."Migration Type");
        SetAbortStatus(DataMigrationStatus);
        OnAfterMigrationFinished(DataMigrationStatus,TRUE,StartTime);
        EXIT(TRUE);
      END;

      DataMigrationStatus.SETRANGE("Destination Table ID",DestinationTableId);
      HandleEntityMigration(DataMigrationStatus,BaseAppCodeunitToRun,ReRun);
    END;

    PROCEDURE SetStartTime@11(Value@1000 : DateTime);
    BEGIN
      StartTime := Value;
    END;

    PROCEDURE SetAbortStatus@3(VAR DataMigrationStatus@1000 : Record 1799);
    BEGIN
      DataMigrationStatus.SETFILTER(
        Status,STRSUBSTNO('%1|%2',DataMigrationStatus.Status::"In Progress",DataMigrationStatus.Status::Pending));
      IF DataMigrationStatus.FINDSET THEN
        REPEAT
          DataMigrationStatus.Status := DataMigrationStatus.Status::Stopped;
          DataMigrationStatus.MODIFY(TRUE);
        UNTIL DataMigrationStatus.NEXT = 0;
    END;

    [Integration(TRUE)]
    PROCEDURE OnBeforeMigrationStarted@2();
    BEGIN
    END;

    [Integration]
    PROCEDURE OnAfterMigrationFinished@12(VAR DataMigrationStatus@1000 : Record 1799;WasAborted@1001 : Boolean;StartTime@1002 : DateTime);
    BEGIN
    END;

    [EventSubscriber(Codeunit,1798,OnBeforeMigrationStarted,"",Skip,Skip)]
    LOCAL PROCEDURE OnBeforeMigrationStartedSubscriber@8(VAR Sender@1000 : Codeunit 1798);
    BEGIN
      Sender.SetStartTime(CURRENTDATETIME);
    END;

    [EventSubscriber(Codeunit,1798,OnAfterMigrationFinished,"",Skip,Skip)]
    LOCAL PROCEDURE OnAfterMigrationFinishedSubscriber@10(VAR DataMigrationStatus@1000 : Record 1799;WasAborted@1001 : Boolean;StartTime@1003 : DateTime);
    VAR
      TotalNumberOfRecords@1002 : Integer;
      Message@1004 : Text;
    BEGIN
      DataMigrationStatus.SETRANGE("Destination Table ID",DATABASE::"G/L Account");
      IF DataMigrationStatus.FINDFIRST THEN
        TotalNumberOfRecords += DataMigrationStatus."Total Number";

      DataMigrationStatus.SETRANGE("Destination Table ID",DATABASE::Item);
      IF DataMigrationStatus.FINDFIRST THEN
        TotalNumberOfRecords += DataMigrationStatus."Total Number";

      DataMigrationStatus.SETRANGE("Destination Table ID",DATABASE::Vendor);
      IF DataMigrationStatus.FINDFIRST THEN
        TotalNumberOfRecords += DataMigrationStatus."Total Number";

      DataMigrationStatus.SETRANGE("Destination Table ID",DATABASE::Customer);
      IF DataMigrationStatus.FINDFIRST THEN
        TotalNumberOfRecords += DataMigrationStatus."Total Number";

      IF WasAborted THEN
        Message := STRSUBSTNO('Migration aborted after %1',CURRENTDATETIME - StartTime)
      ELSE
        Message := STRSUBSTNO('The migration of %1 records in total took: %2',TotalNumberOfRecords,CURRENTDATETIME - StartTime);

      SENDTRACETAG(
        '00001DA',
        STRSUBSTNO('Data Migration (%1)',DataMigrationStatus."Migration Type"),
        VERBOSITY::Normal,
        Message);
    END;

    [External]
    PROCEDURE StartMigration@4(MigrationType@1000 : Text[250];Retry@1001 : Boolean);
    VAR
      DataMigrationError@1006 : Record 1797;
      DataMigrationStatus@1004 : Record 1799;
      JobQueueEntry@1003 : Record 472;
      JobParameters@1005 : Text[250];
      StartNewSession@1002 : Boolean;
      CheckExistingData@1007 : Boolean;
    BEGIN
      CheckMigrationInProgress;

      StartNewSession := TRUE;
      CheckExistingData := TRUE;
      OnBeforeStartMigration(StartNewSession,CheckExistingData);

      IF CheckExistingData THEN
        CheckDataAlreadyExist(MigrationType,Retry);

      DataMigrationStatus.RESET;
      DataMigrationStatus.SETRANGE("Migration Type",MigrationType);
      IF NOT Retry THEN BEGIN
        DataMigrationError.SETRANGE("Migration Type",MigrationType);
        DataMigrationError.DELETEALL;
        COMMIT;
      END;

      IF Retry THEN
        JobParameters := RetryTxt;
      DataMigrationStatus.FINDFIRST;
      IF StartNewSession THEN
        // run the migration in a background session
        JobQueueEntry.ScheduleJobQueueEntryWithParameters(CODEUNIT::"Data Migration Mgt.",
          DataMigrationStatus.RECORDID,JobParameters)
      ELSE BEGIN
        JobQueueEntry."Record ID to Process" := DataMigrationStatus.RECORDID;
        JobQueueEntry."Parameter String" := JobParameters;
        CODEUNIT.RUN(CODEUNIT::"Data Migration Mgt.",JobQueueEntry);
      END;
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeStartMigration@6(VAR StartNewSession@1000 : Boolean;VAR CheckExistingData@1001 : Boolean);
    BEGIN
    END;

    [External]
    PROCEDURE CheckMigrationInProgress@13();
    VAR
      JobQueueEntry@1001 : Record 472;
      DataMigrationOverview@1003 : Page 1799;
    BEGIN
      JobQueueEntry.SETRANGE("Object Type to Run",JobQueueEntry."Object Type to Run"::Codeunit);
      JobQueueEntry.SETRANGE("Object ID to Run",CODEUNIT::"Data Migration Mgt.");
      JobQueueEntry.SETFILTER(Status,'%1|%2|%3',
        JobQueueEntry.Status::"In Process",
        JobQueueEntry.Status::"On Hold",
        JobQueueEntry.Status::Ready);
      IF NOT JobQueueEntry.ISEMPTY THEN
        ERROR(DataMigrationNotCompletedErr,DataMigrationOverview.CAPTION);
    END;

    LOCAL PROCEDURE CheckDataAlreadyExist@7(MigrationType@1001 : Text[250];Retry@1000 : Boolean);
    BEGIN
      IF Retry THEN
        EXIT;

      // check tables are clear. For GL accounts, we delete them automatically
      ThrowErrorIfTableNotEmpty(MigrationType,DATABASE::Customer,CustomerTableNotEmptyErr);
      ThrowErrorIfTableNotEmpty(MigrationType,DATABASE::Vendor,VendorTableNotEmptyErr);
      ThrowErrorIfTableNotEmpty(MigrationType,DATABASE::Item,ItemTableNotEmptyErr);
    END;

    LOCAL PROCEDURE ThrowErrorIfTableNotEmpty@17(MigrationType@1004 : Text[250];TableId@1000 : Integer;ErrorMessageErr@1001 : Text);
    VAR
      DataMigrationStatus@1002 : Record 1799;
      RecRef@1003 : RecordRef;
    BEGIN
      IF DataMigrationStatus.GET(MigrationType,TableId) THEN BEGIN
        RecRef.OPEN(TableId);
        IF NOT RecRef.ISEMPTY THEN
          ERROR(ErrorMessageErr);
      END;
    END;

    BEGIN
    END.
  }
}

