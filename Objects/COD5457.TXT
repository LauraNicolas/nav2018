OBJECT Codeunit 5457 Graph Sync. - Contact
{
  OBJECT-PROPERTIES
  {
    Date=28.05.17;
    Time=12:00:00;
    Version List=NAVW110.0;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      IntegrationMappingCodeTxt@1001 : TextConst '@@@={Locked};ENU=SyncGraphContact';
      InboundConnectionNameTxt@1002 : TextConst '@@@={Locked};ENU=InboundContact';
      SubscriptionConnectionNameTxt@1003 : TextConst '@@@={Locked};ENU=SubscribeContact';
      SynchronizeConnectionNameTxt@1000 : TextConst '@@@={Locked};ENU=SynchronizeContact';

    LOCAL PROCEDURE CanHandleMapping@13(MappingCode@1000 : Code[20]) : Boolean;
    BEGIN
      EXIT(UPPERCASE(MappingCode) = UPPERCASE(IntegrationMappingCodeTxt));
    END;

    LOCAL PROCEDURE EntityEndpoint@17() : Text[250];
    BEGIN
      EXIT('https://outlook.office365.com/api/beta/users(''{SHAREDCONTACTS}'')/contacts');
    END;

    LOCAL PROCEDURE EntityListEndpoint@18() : Text[250];
    BEGIN
      EXIT('https://outlook.office365.com/api/beta/users(''{SHAREDCONTACTS}'')/contactfolders(''sharedbusinesscontacts'')/contacts');
    END;

    LOCAL PROCEDURE GetEntityTableID@35() : Integer;
    BEGIN
      EXIT(DATABASE::Contact);
    END;

    LOCAL PROCEDURE GetInboundConnectionString@16() : Text;
    VAR
      GraphConnectionSetup@1000 : Codeunit 5456;
    BEGIN
      EXIT(GraphConnectionSetup.ConstructConnectionString(EntityEndpoint,EntityListEndpoint,ResourceUri,''));
    END;

    LOCAL PROCEDURE GetSubscriptionConnectionString@20() : Text;
    VAR
      GraphConnectionSetup@1000 : Codeunit 5456;
    BEGIN
      EXIT(GraphConnectionSetup.ConstructConnectionString(SubscriptionEndpoint,SubscriptionEndpoint,ResourceUri,''));
    END;

    LOCAL PROCEDURE GetSynchronizeConnectionString@21() : Text;
    VAR
      GraphConnectionSetup@1000 : Codeunit 5456;
    BEGIN
      EXIT(GraphConnectionSetup.ConstructConnectionString(EntityEndpoint,EntityListEndpoint,ResourceUri,''));
    END;

    LOCAL PROCEDURE GetWebhookSubscription@5(VAR WebhookSubscription@1000 : Record 2000000199) : Boolean;
    VAR
      WebhookManagement@1007 : Codeunit 5377;
      EndpointUri@1002 : DotNet "'System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Uri";
    BEGIN
      EndpointUri := EndpointUri.Uri(EntityListEndpoint);
      EXIT(WebhookManagement.FindWebhookSubscriptionMatchingEndPoint(
          WebhookSubscription,
          EndpointUri,
          STRPOS(EndpointUri.PathAndQuery,'(''%7BSHAREDCONTACTS%7D'')'),
          24));
    END;

    LOCAL PROCEDURE ResourceUri@29() : Text;
    BEGIN
      EXIT('https://outlook.office365.com');
    END;

    LOCAL PROCEDURE SubscriptionEndpoint@19() : Text[250];
    BEGIN
      EXIT('https://outlook.office365.com/api/beta/users(''{SHAREDCONTACTS}'')/subscriptions');
    END;

    [EventSubscriber(Codeunit,5455,OnAddIntegrationMapping)]
    LOCAL PROCEDURE OnAddContactIntegrationMapping@4(MappingCode@1000 : Code[20]);
    VAR
      Contact@1002 : Record 5050;
      GraphContact@1003 : Record 5450;
      GraphDataSetup@1001 : Codeunit 5455;
    BEGIN
      IF NOT CanHandleMapping(MappingCode) THEN
        EXIT;

      // Add Graph Contact <=> Contact table mapping
      GraphDataSetup.AddIntegrationTableMapping(MappingCode,DATABASE::Contact,DATABASE::"Graph Contact",
        GraphContact.FIELDNO(Id),GraphContact.FIELDNO(LastModifiedDateTime),'',GraphContact.FIELDNO(DeltaToken),
        GraphContact.FIELDNO(ChangeKey),GraphContact.FIELDNO(IsNavCreated));

      // Add Graph Contact <=> Contact field mapping
      GraphDataSetup.AddIntgrationFieldMapping(MappingCode,Contact.FIELDNO("First Name"),GraphContact.FIELDNO(GivenName),FALSE);
      GraphDataSetup.AddIntgrationFieldMapping(MappingCode,Contact.FIELDNO("Middle Name"),GraphContact.FIELDNO(MiddleName),FALSE);
      GraphDataSetup.AddIntgrationFieldMapping(MappingCode,Contact.FIELDNO(Surname),GraphContact.FIELDNO(Surname),FALSE);
      GraphDataSetup.AddIntgrationFieldMapping(MappingCode,Contact.FIELDNO(Initials),GraphContact.FIELDNO(Initials),FALSE);
      GraphDataSetup.AddIntgrationFieldMapping(MappingCode,Contact.FIELDNO("Job Title"),GraphContact.FIELDNO(JobTitle),FALSE);
      GraphDataSetup.AddIntgrationFieldMapping(MappingCode,Contact.FIELDNO("Company Name"),GraphContact.FIELDNO(CompanyName),FALSE);
    END;

    [EventSubscriber(Codeunit,5450,OnBeforeAddOrUpdateGraphSubscriptions)]
    LOCAL PROCEDURE OnBeforeAddOrUpdateGraphSubscription@2(VAR FirstTimeSync@1000 : Boolean);
    VAR
      WebhookSubscription@1001 : Record 2000000199;
      GraphSubscriptionMgt@1003 : Codeunit 5450;
      WebhookExists@1004 : Boolean;
    BEGIN
      SETDEFAULTTABLECONNECTION(TABLECONNECTIONTYPE::MicrosoftGraph,SubscriptionConnectionNameTxt,TRUE);
      WebhookExists := GetWebhookSubscription(WebhookSubscription);
      GraphSubscriptionMgt.AddOrUpdateGraphSubscription(FirstTimeSync,WebhookExists,WebhookSubscription,EntityListEndpoint);
    END;

    [EventSubscriber(Codeunit,5455,OnCreateIntegrationMappings)]
    LOCAL PROCEDURE OnCreateContactIntegrationMappings@6();
    VAR
      GraphDataSetup@1000 : Codeunit 5455;
    BEGIN
      GraphDataSetup.CreateIntegrationMapping(IntegrationMappingCodeTxt);
    END;

    [EventSubscriber(Codeunit,5446,OnFindWebhookSubscription)]
    LOCAL PROCEDURE OnFindWebhookSubscription@7(VAR WebhookSubscription@1000 : Record 2000000199;SubscriptionID@1001 : Text[150];VAR IntegrationMappingCode@1002 : Code[20]);
    VAR
      WebhookManagement@1004 : Codeunit 5377;
    BEGIN
      IF IntegrationMappingCode <> '' THEN
        EXIT;

      IF NOT WebhookManagement.FindWebhookSubscriptionSafe(WebhookSubscription,SubscriptionID,EntityListEndpoint) THEN
        EXIT;

      IntegrationMappingCode := IntegrationMappingCodeTxt;
    END;

    [EventSubscriber(Codeunit,5455,OnGetGraphRecord)]
    LOCAL PROCEDURE OnGetGraphRecord@11(VAR GraphRecordRef@1000 : RecordRef;DestinationGraphID@1001 : Text[250];TableID@1002 : Integer);
    VAR
      GraphContact@1003 : Record 5450;
    BEGIN
      IF TableID = GetEntityTableID THEN BEGIN
        GraphContact.GET(DestinationGraphID);
        GraphRecordRef.GETTABLE(GraphContact);
      END;
    END;

    [EventSubscriber(Codeunit,5456,OnGetInboundConnectionName)]
    LOCAL PROCEDURE OnGetInboundConnectionName@10(TableID@1000 : Integer;VAR ConnectionName@1001 : Text);
    BEGIN
      IF TableID = GetEntityTableID THEN
        ConnectionName := InboundConnectionNameTxt;
    END;

    [EventSubscriber(Codeunit,5456,OnGetInboundConnectionString)]
    LOCAL PROCEDURE OnGetInboundConnectionString@24(TableID@1000 : Integer;VAR ConnectionString@1001 : Text);
    BEGIN
      IF TableID = GetEntityTableID THEN
        ConnectionString := GetInboundConnectionString;
    END;

    [EventSubscriber(Codeunit,5455,OnGetInboundTableID)]
    LOCAL PROCEDURE OnGetInboundTableID@14(MappingCode@1000 : Code[20];VAR TableID@1001 : Integer);
    BEGIN
      IF CanHandleMapping(MappingCode) THEN
        TableID := DATABASE::Contact;
    END;

    [EventSubscriber(Codeunit,5455,OnGetMappingCodeForTable)]
    LOCAL PROCEDURE OnGetMappingCode@12(TableID@1000 : Integer;VAR MappingCode@1001 : Code[20]);
    BEGIN
      IF TableID = GetEntityTableID THEN
        MappingCode := IntegrationMappingCodeTxt;
    END;

    [EventSubscriber(Codeunit,5450,OnGetSourceRecordRef)]
    LOCAL PROCEDURE OnGetSourceRecordRef@26(VAR GraphRecordRef@1000 : RecordRef;WebhookNotification@1001 : Record 2000000194;IntegrationTableID@1002 : Integer;VAR Retrieved@1003 : Boolean);
    VAR
      GraphContact@1004 : Record 5450;
    BEGIN
      IF IntegrationTableID = DATABASE::"Graph Contact" THEN
        IF GraphContact.GET(WebhookNotification."Resource ID") THEN BEGIN
          GraphRecordRef.GETTABLE(GraphContact);
          Retrieved := TRUE;
        END;
    END;

    [EventSubscriber(Codeunit,5456,OnGetSubscriptionConnectionName)]
    LOCAL PROCEDURE OnGetSubscriptionConnectionName@27(TableID@1000 : Integer;VAR ConnectionName@1001 : Text);
    BEGIN
      IF TableID = GetEntityTableID THEN
        ConnectionName := SubscriptionConnectionNameTxt;
    END;

    [EventSubscriber(Codeunit,5456,OnGetSubscriptionConnectionString)]
    LOCAL PROCEDURE OnGetSubscriptionConnectionString@28(TableID@1000 : Integer;VAR ConnectionString@1001 : Text);
    BEGIN
      IF TableID = GetEntityTableID THEN
        ConnectionString := GetSubscriptionConnectionString;
    END;

    [EventSubscriber(Codeunit,5456,OnGetSynchronizeConnectionName)]
    LOCAL PROCEDURE OnGetSynchronizeConnectionName@9(TableID@1000 : Integer;VAR ConnectionName@1001 : Text);
    BEGIN
      IF TableID = GetEntityTableID THEN
        ConnectionName := SynchronizeConnectionNameTxt;
    END;

    [EventSubscriber(Codeunit,5456,OnGetSynchronizeConnectionString)]
    LOCAL PROCEDURE OnGetSynchronizeConnectionString@25(TableID@1000 : Integer;VAR ConnectionString@1001 : Text);
    BEGIN
      IF TableID = GetEntityTableID THEN
        ConnectionString := GetSynchronizeConnectionString;
    END;

    [EventSubscriber(Codeunit,5456,OnRegisterConnections)]
    LOCAL PROCEDURE OnRegisterConnections@15();
    VAR
      GraphConnectionSetup@1000 : Codeunit 5456;
    BEGIN
      GraphConnectionSetup.RegisterConnectionForEntity(
        InboundConnectionNameTxt,GetInboundConnectionString,
        SubscriptionConnectionNameTxt,GetSubscriptionConnectionString,
        SynchronizeConnectionNameTxt,GetSynchronizeConnectionString);
    END;

    [EventSubscriber(Codeunit,5452,OnRunGraphDeltaSync)]
    LOCAL PROCEDURE OnRunContactDeltaSync@1();
    VAR
      GraphSyncRunner@1000 : Codeunit 5452;
    BEGIN
      GraphSyncRunner.RunDeltaSyncForEntity(DATABASE::Contact);
    END;

    [EventSubscriber(Codeunit,5452,OnRunGraphFullSync)]
    LOCAL PROCEDURE OnRunContactFullSync@3();
    VAR
      GraphSyncRunner@1000 : Codeunit 5452;
    BEGIN
      GraphSyncRunner.RunFullSyncForEntity(DATABASE::Contact);
    END;

    [EventSubscriber(Codeunit,5345,OnFindUncoupledDestinationRecord)]
    LOCAL PROCEDURE OnFindUncoupledDestinationRecord@23(IntegrationTableMapping@1000 : Record 5335;SourceRecordRef@1001 : RecordRef;VAR DestinationRecordRef@1002 : RecordRef;VAR DestinationIsDeleted@1003 : Boolean;VAR DestinationFound@1004 : Boolean);
    VAR
      GraphContact@1005 : Record 5450;
      IntegrationRecord@1007 : Record 5151;
      GraphCollectionMgtContact@1011 : Codeunit 5458;
      GraphIntegrationId@1006 : GUID;
      GraphIntegrationIdValue@1010 : Text;
    BEGIN
      IF NOT CanHandleMapping(IntegrationTableMapping.Name) THEN
        EXIT;

      IF NOT IntegrationRecord.FindByRecordId(SourceRecordRef.RECORDID) THEN
        EXIT;

      IF SourceRecordRef.NUMBER = GetEntityTableID THEN BEGIN
        IF GraphContact.FINDSET THEN
          REPEAT
            GraphIntegrationIdValue := GraphCollectionMgtContact.GetNavIntegrationId(GraphContact.GetNavIntegrationIdString);
            IF EVALUATE(GraphIntegrationId,GraphIntegrationIdValue) THEN
              IF IntegrationRecord."Integration ID" = GraphIntegrationId THEN BEGIN
                DestinationFound := TRUE;
                DestinationRecordRef.GETTABLE(GraphContact);
                EXIT;
              END;
          UNTIL GraphContact.NEXT = 0;
      END;
    END;

    [EventSubscriber(Table,5050,OnAfterDeleteEvent)]
    LOCAL PROCEDURE UpdateGraphOnAfterContactDelete@8(VAR Rec@1000 : Record 5050;RunTrigger@1001 : Boolean);
    VAR
      GraphSubscriptionManagement@1008 : Codeunit 5450;
      EntityRecordRef@1002 : RecordRef;
    BEGIN
      EntityRecordRef.GETTABLE(Rec);
      GraphSubscriptionManagement.UpdateGraphOnAfterDelete(EntityRecordRef);
    END;

    [EventSubscriber(Table,5050,OnAfterModifyEvent)]
    LOCAL PROCEDURE UpdateGraphOnAfterContactModify@22(VAR Rec@1000 : Record 5050;VAR xRec@1001 : Record 5050;RunTrigger@1002 : Boolean);
    VAR
      GraphSubscriptionManagement@1008 : Codeunit 5450;
      EntityRecordRef@1003 : RecordRef;
    BEGIN
      EntityRecordRef.GETTABLE(Rec);
      GraphSubscriptionManagement.UpdateGraphOnAfterModify(EntityRecordRef);
    END;

    BEGIN
    END.
  }
}

