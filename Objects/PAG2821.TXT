OBJECT Page 2821 Native - PDFs
{
  OBJECT-PROPERTIES
  {
    Date=06.10.17;
    Time=12:00:00;
    Version List=NAVW111.0;
  }
  PROPERTIES
  {
    Editable=No;
    CaptionML=[@@@={Locked};
               ENU=nativeInvoicingPDFs];
    SourceTable=Table5509;
    PageType=List;
    SourceTableTemporary=Yes;
    OnFindRecord=VAR
                   DocumentId@1005 : GUID;
                   DocumentIdFilter@1001 : Text;
                   FilterView@1000 : Text;
                 BEGIN
                   IF NOT PdfGenerated THEN BEGIN
                     FilterView := GETVIEW;
                     DocumentIdFilter := GETFILTER("Document Id");
                     IF DocumentIdFilter = '' THEN
                       DocumentIdFilter := GETFILTER(Id);
                     SETVIEW(FilterView);
                     DocumentId := GetDocumentId(DocumentIdFilter);
                     IF ISNULLGUID(DocumentId) THEN
                       EXIT(FALSE);
                     GeneratePdf(DocumentId);
                   END;
                   EXIT(TRUE);
                 END;

    ODataKeyFields=Document Id;
  }
  CONTROLS
  {
    { 18  ;0   ;Container ;
                ContainerType=ContentArea }

    { 17  ;1   ;Group     ;
                Name=Group;
                GroupType=Repeater }

    { 1   ;2   ;Field     ;
                Name=documentId;
                CaptionML=[@@@={Locked};
                           ENU=documentId];
                ApplicationArea=#All;
                SourceExpr="Document Id" }

    { 7   ;2   ;Field     ;
                Name=fileName;
                CaptionML=[@@@={Locked};
                           ENU=fileName];
                ApplicationArea=#All;
                SourceExpr="File Name" }

    { 4   ;2   ;Field     ;
                Name=content;
                CaptionML=[@@@={Locked};
                           ENU=content];
                ApplicationArea=#All;
                SourceExpr=Content }

  }
  CODE
  {
    VAR
      CannotFindDocumentErr@1006 : TextConst '@@@={Locked};ENU=The document %1 cannot be found.';
      CannotOpenFileErr@1005 : TextConst '@@@={Locked};ENU=Opening the file failed because of the following error: \%1.';
      InvoiceFileTxt@1000 : TextConst '@@@={Locked};ENU=Sales invoice %1 from %2';
      DraftInvoiceFileTxt@1001 : TextConst '@@@={Locked};ENU=Draft sales invoice %1 from %2';
      QuoteFileTxt@1007 : TextConst '@@@={Locked};ENU=Sales quote %1 from %2';
      DocumentIDNotSpecifiedForAttachmentsErr@1010 : TextConst '@@@={Locked};ENU=You must specify a document ID to get the PDF.';
      DocumentDoesNotExistErr@1009 : TextConst '@@@={Locked};ENU=No document with the specified ID exists.';
      PdfGenerated@1002 : Boolean;

    LOCAL PROCEDURE GetDocumentId@5(DocumentIdFilter@1001 : Text) : GUID;
    VAR
      SalesHeader@1003 : Record 36;
      SalesInvoiceHeader@1004 : Record 112;
      DataTypeManagement@1006 : Codeunit 701;
      DocumentRecordRef@1000 : RecordRef;
      DocumentIdFieldRef@1005 : FieldRef;
      DocumentId@1002 : GUID;
    BEGIN
      IF DocumentIdFilter = '' THEN
        ERROR(DocumentIDNotSpecifiedForAttachmentsErr);

      SalesHeader.SETFILTER(Id,DocumentIdFilter);
      IF SalesHeader.FINDFIRST THEN
        DocumentRecordRef.GETTABLE(SalesHeader)
      ELSE BEGIN
        SalesInvoiceHeader.SETFILTER(Id,DocumentIdFilter);
        IF SalesInvoiceHeader.FINDFIRST THEN
          DocumentRecordRef.GETTABLE(SalesInvoiceHeader)
        ELSE
          ERROR(DocumentDoesNotExistErr);
      END;

      DataTypeManagement.FindFieldByName(DocumentRecordRef,DocumentIdFieldRef,SalesHeader.FIELDNAME(Id));
      EVALUATE(DocumentId,FORMAT(DocumentIdFieldRef.VALUE));

      EXIT(DocumentId);
    END;

    LOCAL PROCEDURE GeneratePdf@21(DocumentId@1009 : GUID);
    VAR
      CompanyInformation@1004 : Record 79;
      SalesInvoiceHeader@1002 : Record 112;
      SalesHeader@1006 : Record 36;
      ReportSelections@1005 : Record 77;
      NativeReports@1011 : Codeunit 2822;
      File@1007 : File;
      InStream@1008 : InStream;
      OutStream@1010 : OutStream;
      Path@1001 : Text[250];
      Name@1000 : Text[250];
    BEGIN
      CompanyInformation.GET;
      SalesHeader.SETRANGE(Id,DocumentId);
      IF SalesHeader.FINDFIRST THEN
        CASE SalesHeader."Document Type" OF
          SalesHeader."Document Type"::Invoice:
            BEGIN
              ReportSelections.GetPdfReport(
                Path,NativeReports.DraftSalesInvoiceReportId,SalesHeader,SalesHeader."Sell-to Customer No.");
              Name := STRSUBSTNO(DraftInvoiceFileTxt,SalesHeader."No.",CompanyInformation.Name);
            END;
          SalesHeader."Document Type"::Quote:
            BEGIN
              ReportSelections.GetPdfReport(
                Path,NativeReports.SalesQuoteReportId,SalesHeader,SalesHeader."Sell-to Customer No.");
              Name := STRSUBSTNO(QuoteFileTxt,SalesHeader."No.",CompanyInformation.Name);
            END;
          ELSE
            ERROR(CannotFindDocumentErr,DocumentId);
        END
      ELSE BEGIN
        SalesInvoiceHeader.SETRANGE(Id,DocumentId);
        IF SalesInvoiceHeader.FINDFIRST THEN BEGIN
          ReportSelections.GetPdfReport(
            Path,NativeReports.PostedSalesInvoiceReportId,SalesInvoiceHeader,SalesInvoiceHeader."Sell-to Customer No.");
          Name := STRSUBSTNO(InvoiceFileTxt,SalesInvoiceHeader."No.",CompanyInformation.Name);
        END ELSE
          ERROR(CannotFindDocumentErr,DocumentId);
      END;

      IF NOT File.OPEN(Path) THEN
        ERROR(CannotOpenFileErr,GETLASTERRORTEXT);

      INIT;
      Id := DocumentId;
      "Document Id" := DocumentId;
      "File Name" := Name;
      Type := Type::PDF;
      Content.CREATEOUTSTREAM(OutStream);
      File.CREATEINSTREAM(InStream);
      COPYSTREAM(OutStream,InStream);
      File.CLOSE;
      IF ERASE(Path) THEN;
      INSERT(TRUE);

      PdfGenerated := TRUE;
    END;

    BEGIN
    END.
  }
}

