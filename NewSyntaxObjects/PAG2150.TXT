OBJECT Page 2150 O365 Sales Email Dialog
{
  OBJECT-PROPERTIES
  {
    Date=20171006D;
    Time=120000T;
    Version List=NAVW111.0;
  }
  PROPERTIES
  {
    CaptionML=ENU=Send Email;
    SourceTable="Email Item";
    PageType=StandardDialog;
    SourceTableTemporary=true;
    RefreshOnActivate=true;
    OnOpenPage=BEGIN
                 // Set CC and BCC field
                 TempEmailItem.FINDFIRST;
                 UpdateCcBccText(TempEmailItem."Send CC",TempEmailItem."Send BCC");
                 SendTo := COPYSTR(TempEmailItem."Send to",1,MAXSTRLEN(SendTo));
                 SubjectText := TempEmailItem.Subject;

                 IsPhoneClient := CURRENTCLIENTTYPE = CLIENTTYPE::Phone;
               END;

    OnQueryClosePage=BEGIN
                       TempEmailItem.MODIFY(true);
                       Rec := TempEmailItem;
                       if CloseAction <> ACTION::OK then
                         exit;
                       if TempEmailItem."Send to" = '' then
                         ERROR(MustSpecifyToEmailAddressErr);
                     END;

    OnAfterGetCurrRecord=BEGIN
                           if not DocumentHeaderRecordVariant.ISRECORD then
                             exit;
                           UpdateNoOfAttachmentsLabel(O365SalesAttachmentMgt.GetNoOfAttachments(DocumentHeaderRecordVariant));
                         END;

  }
  CONTROLS
  {
    { 1   ;0   ;Container ;
                Name=Container1;
                ContainerType=ContentArea }

    { 10  ;1   ;Field     ;
                Name=SendToText;
                ExtendedDatatype=E-Mail;
                CaptionML=ENU=To;
                ToolTipML=ENU=Specifies the recipient of the email.;
                ApplicationArea=#Basic,#Suite,#Invoicing;
                SourceExpr=SendTo;
                OnValidate=VAR
                             MailManagement@1000 : Codeunit "Mail Management";
                           BEGIN
                             MailManagement.CheckValidEmailAddresses(SendTo);
                             if SendTo <> TempEmailItem."Send to" then
                               GetEmailBody(SendTo);
                             TempEmailItem."Send to" := SendTo;
                           END;

                ImplicitType=Text80 }

    { 4   ;1   ;Field     ;
                Name=CcBccText;
                CaptionML=ENU=CC/BCC;
                ToolTipML=ENU=Specifies one or more additional recipients.;
                ApplicationArea=#Basic,#Suite,#Invoicing;
                SourceExpr=CcAndBcc;
                Importance=Additional;
                Editable=IsPhoneClient;
                OnAssistEdit=BEGIN
                               if CURRENTCLIENTTYPE = CLIENTTYPE::Tablet then
                                 PAGE.RUNMODAL(PAGE::"BC O365 Email Settings")
                               else
                                 PAGE.RUNMODAL(PAGE::"O365 Email CC and BCC Settings");

                               TempEmailItem.AddCcBcc;
                               UpdateCcBccText(TempEmailItem."Send CC",TempEmailItem."Send BCC");
                             END;

                ImplicitType=Text;
                QuickEntry=FALSE }

    { 11  ;1   ;Field     ;
                Name=Subject;
                CaptionML=ENU=Subject;
                ToolTipML=ENU=Specifies the text that will display as the subject of the email.;
                ApplicationArea=#Basic,#Suite,#Invoicing;
                SourceExpr=SubjectText;
                OnValidate=BEGIN
                             TempEmailItem.Subject := SubjectText;
                           END;

                ImplicitType=Text250 }

    { 15  ;1   ;Field     ;
                Name=ShowEmailContentLbl;
                ApplicationArea=#Basic,#Suite,#Invoicing;
                SourceExpr=ShowEmailContentLbl;
                Editable=FALSE;
                OnDrillDown=VAR
                              O365EmailPreview@1000 : Page "O365 Email Preview";
                            BEGIN
                              O365EmailPreview.LoadHTMLFile(TempEmailItem."Body File Path");
                              O365EmailPreview.RUNMODAL;
                            END;

                ImplicitType=TextConst;
                ShowCaption=false }

    { 13  ;1   ;Group     ;
                Name=Attachments;
                CaptionML=ENU=Attachments;
                GroupType=Group }

    { 12  ;1   ;Field     ;
                Name=AttachmentName;
                ApplicationArea=#Basic,#Suite,#Invoicing;
                SourceExpr=ViewPdfInvoiceLbl;
                Visible=HasInvoiceAttachment;
                Editable=FALSE;
                OnDrillDown=BEGIN
                              if HasInvoiceAttachment then
                                DOWNLOAD(TempEmailItem."Attachment File Path",'','','',TempEmailItem."Attachment File Path");
                            END;

                ImplicitType=TextConst;
                ShowCaption=false }

    { 16  ;1   ;Field     ;
                Name=NoOfAttachmentsValueTxt;
                ApplicationArea=#Basic,#Suite,#Invoicing;
                SourceExpr=NoOfAttachmentsValueTxt;
                Editable=FALSE;
                OnDrillDown=VAR
                              SalesHeader@1001 : Record "Sales Header";
                              RecRef@1000 : RecordRef;
                            BEGIN
                              if not DocumentHeaderRecordVariant.ISRECORD then
                                exit;
                              UpdateNoOfAttachmentsLabel(O365SalesAttachmentMgt.EditAttachments(DocumentHeaderRecordVariant));
                              if not GetSalesHeader(DocumentHeaderRecordVariant,SalesHeader) then
                                exit;
                              RecRef.GETTABLE(DocumentHeaderRecordVariant);
                              if RecRef.NUMBER = DATABASE::"Sales Header" then begin
                                SalesHeader := DocumentHeaderRecordVariant;
                                if SalesHeader.FIND then
                                  DocumentHeaderRecordVariant := SalesHeader;
                              end;
                            END;

                ImplicitType=Text;
                ShowCaption=false }

  }
  CODE
  {
    VAR
      TempEmailItem@1000 : TEMPORARY Record "Email Item";
      O365SalesAttachmentMgt@1005 : Codeunit "O365 Sales Attachment Mgt";
      DocumentHeaderRecordVariant@1007 : Variant;
      SendTo@1008 : Text[80];
      CcAndBcc@1001 : Text;
      MustSpecifyToEmailAddressErr@1003 : TextConst 'ENU=Please enter a recipient email address.';
      ShowEmailContentLbl@1014 : TextConst 'ENU=View email message';
      NoOfAttachmentsTxt@1012 : TextConst '@@@="%1=an integer number, starting at 0";ENU=Other attachments (%1)';
      NoOfAttachmentsValueTxt@1006 : Text;
      AddAttachmentTxt@1004 : TextConst 'ENU=Add attachment';
      ViewPdfInvoiceLbl@1019 : TextConst 'ENU=PDF invoice';
      SubjectText@1002 : Text[250];
      HasInvoiceAttachment@1011 : Boolean;
      IsPhoneClient@1009 : Boolean;

    [External]
    PROCEDURE SetValues@1(NewDocumentHeaderRecordVariant@1001 : Variant;VAR NewTempEmailItem@1000 : TEMPORARY Record "Email Item");
    VAR
      DummyVariant@1002 : Variant;
    BEGIN
      TempEmailItem.COPY(NewTempEmailItem,true);
      DocumentHeaderRecordVariant := NewDocumentHeaderRecordVariant;
      HasInvoiceAttachment := FORMAT(DocumentHeaderRecordVariant) <> FORMAT(DummyVariant);
      GetEmailBody('');
    END;

    LOCAL PROCEDURE GetEmailBody@3(SendTo@1003 : Text[250]);
    VAR
      SalesHeader@1000 : Record "Sales Header";
      ReportSelections@1001 : Record "Report Selections";
      ReportUsage@1002 : Option;
    BEGIN
      if not GetSalesHeader(DocumentHeaderRecordVariant,SalesHeader) then
        exit;
      case SalesHeader."Document Type" of
        SalesHeader."Document Type"::Quote:
          ReportUsage := ReportSelections.Usage::"S.Quote";
        SalesHeader."Document Type"::Invoice:
          ReportUsage := ReportSelections.Usage::"S.Invoice Draft";
        else
          ReportUsage := ReportSelections.Usage::"S.Invoice Draft"; // default
      end;
      if ReportSelections.GetEmailBody(
           TempEmailItem."Body File Path",ReportUsage,DocumentHeaderRecordVariant,SalesHeader."Sell-to Customer No.",SendTo)
      then
        TempEmailItem.MODIFY;
      COMMIT;
    END;

    LOCAL PROCEDURE GetSalesHeader@4(DocVariant@1000 : Variant;VAR SalesHeader@1001 : Record "Sales Header") : Boolean;
    VAR
      RecRef@1002 : RecordRef;
    BEGIN
      if not DocVariant.ISRECORD then
        exit(false);
      RecRef.GETTABLE(DocVariant);
      if RecRef.NUMBER <> DATABASE::"Sales Header" then
        exit(false);
      SalesHeader := DocVariant;
      exit(true);
    END;

    LOCAL PROCEDURE UpdateCcBccText@2(SendCC@1001 : Text;SendBCC@1002 : Text);
    BEGIN
      CcAndBcc := SendCC;
      if SendBCC <> '' then begin
        if CcAndBcc <> '' then
          CcAndBcc += '; ';
        CcAndBcc += SendBCC;
      end;
    END;

    LOCAL PROCEDURE UpdateNoOfAttachmentsLabel@7(NoOfAttachments@1000 : Integer);
    BEGIN
      if NoOfAttachments = 0 then
        NoOfAttachmentsValueTxt := AddAttachmentTxt
      else
        NoOfAttachmentsValueTxt := STRSUBSTNO(NoOfAttachmentsTxt,NoOfAttachments);
    END;

    BEGIN
    END.
  }
}

