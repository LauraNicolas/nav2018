OBJECT Table 5077 Segment Line
{
  OBJECT-PROPERTIES
  {
    Date=20171006D;
    Time=120000T;
    Version List=NAVW111.0;
  }
  PROPERTIES
  {
    OnDelete=VAR
               SegLine@1001 : Record "Segment Line";
               SegmentCriteriaLine@1002 : Record "Segment Criteria Line";
               SegmentHistory@1003 : Record "Segment History";
               SegInteractLanguage@1005 : Record "Segment Interaction Language";
               Task@1000 : Record "To-do";
             BEGIN
               CampaignTargetGrMgt.DeleteSegfromTargetGr(Rec);

               SegInteractLanguage.RESET;
               SegInteractLanguage.SETRANGE("Segment No.","Segment No.");
               SegInteractLanguage.SETRANGE("Segment Line No.","Line No.");
               SegInteractLanguage.DELETEALL(true);
               GET("Segment No.","Line No.");

               SegLine.SETRANGE("Segment No.","Segment No.");
               SegLine.SETFILTER("Line No.",'<>%1',"Line No.");
               if SegLine.ISEMPTY then begin
                 if SegHeader.GET("Segment No.") then
                   SegHeader.CALCFIELDS("No. of Criteria Actions");
                 if SegHeader."No. of Criteria Actions" > 1 then
                   if CONFIRM(Text006,true) then begin
                     SegmentCriteriaLine.SETRANGE("Segment No.","Segment No.");
                     SegmentCriteriaLine.DELETEALL;
                     SegmentHistory.SETRANGE("Segment No.","Segment No.");
                     SegmentHistory.DELETEALL;
                   end;
               end;
               if "Contact No." <> '' then begin
                 SegLine.SETRANGE("Contact No.","Contact No.");
                 if SegLine.ISEMPTY then begin
                   Task.SETRANGE("Segment No.","Segment No.");
                   Task.SETRANGE("Contact No.","Contact No.");
                   Task.MODIFYALL("Segment No.",'');
                 end;
               end;
             END;

    CaptionML=ENU=Segment Line;
  }
  FIELDS
  {
    { 1   ;   ;Segment No.         ;Code20        ;TableRelation="Segment Header";
                                                   CaptionML=ENU=Segment No. }
    { 2   ;   ;Line No.            ;Integer       ;CaptionML=ENU=Line No. }
    { 3   ;   ;Contact No.         ;Code20        ;TableRelation=Contact;
                                                   OnValidate=VAR
                                                                SegInteractLanguage@1000 : Record "Segment Interaction Language";
                                                                Attachment@1001 : Record Attachment;
                                                                InteractTmpl@1002 : Record "Interaction Template";
                                                              BEGIN
                                                                InitLine;

                                                                if Cont.GET("Contact No.") then begin
                                                                  "Language Code" := FindLanguage("Interaction Template Code",Cont."Language Code");
                                                                  "Contact Company No." := Cont."Company No.";
                                                                  "Contact Alt. Address Code" := Cont.ActiveAltAddress(Date);
                                                                  if SegHeader.GET("Segment No.") then begin
                                                                    if SegHeader."Salesperson Code" = '' then
                                                                      "Salesperson Code" := Cont."Salesperson Code"
                                                                    else
                                                                      "Salesperson Code" := SegHeader."Salesperson Code";
                                                                    if SegHeader."Ignore Contact Corres. Type" and
                                                                       (SegHeader."Correspondence Type (Default)" <> SegHeader."Correspondence Type (Default)"::" ")
                                                                    then
                                                                      "Correspondence Type" := SegHeader."Correspondence Type (Default)"
                                                                    else
                                                                      if InteractTmpl.GET(SegHeader."Interaction Template Code") and
                                                                         (InteractTmpl."Ignore Contact Corres. Type" or
                                                                          ((InteractTmpl."Ignore Contact Corres. Type" = false) and
                                                                           (Cont."Correspondence Type" = Cont."Correspondence Type"::" ")))
                                                                      then
                                                                        "Correspondence Type" := InteractTmpl."Correspondence Type (Default)"
                                                                      else
                                                                        "Correspondence Type" := Cont."Correspondence Type";
                                                                  end else
                                                                    if not Salesperson.GET(GETFILTER("Salesperson Code")) then
                                                                      "Salesperson Code" := Cont."Salesperson Code";
                                                                end else begin
                                                                  "Contact Company No." := '';
                                                                  "Contact Alt. Address Code" := '';
                                                                  if SegHeader.GET("Segment No.") then
                                                                    "Salesperson Code" := SegHeader."Salesperson Code"
                                                                  else begin
                                                                    "Salesperson Code" := '';
                                                                    "Language Code" := '';
                                                                  end;
                                                                end;
                                                                CALCFIELDS("Contact Name","Contact Company Name");

                                                                if "Segment No." <> '' then begin
                                                                  if UniqueAttachmentExists then begin
                                                                    MODIFY;
                                                                    SegInteractLanguage.RESET;
                                                                    SegInteractLanguage.SETRANGE("Segment No.","Segment No.");
                                                                    SegInteractLanguage.SETRANGE("Segment Line No.","Line No.");
                                                                    SegInteractLanguage.DELETEALL(true);
                                                                    GET("Segment No.","Line No.");
                                                                  end;

                                                                  "Language Code" := FindLanguage("Interaction Template Code","Language Code");
                                                                  if SegInteractLanguage.GET("Segment No.",0,"Language Code") then begin
                                                                    if Attachment.GET(SegInteractLanguage."Attachment No.") then
                                                                      "Attachment No." := SegInteractLanguage."Attachment No.";
                                                                    Subject := SegInteractLanguage.Subject;
                                                                  end;
                                                                end;

                                                                if xRec."Contact No." <> "Contact No." then
                                                                  SetCampaignTargetGroup;
                                                              END;

                                                   CaptionML=ENU=Contact No. }
    { 4   ;   ;Campaign No.        ;Code20        ;TableRelation=Campaign;
                                                   OnValidate=BEGIN
                                                                if xRec."Campaign No." <> "Campaign No." then
                                                                  SetCampaignTargetGroup;
                                                              END;

                                                   CaptionML=ENU=Campaign No. }
    { 5   ;   ;Salesperson Code    ;Code20        ;TableRelation="Salesperson/Purchaser";
                                                   CaptionML=ENU=Salesperson Code }
    { 6   ;   ;Correspondence Type ;Option        ;OnValidate=VAR
                                                                Attachment@1000 : Record Attachment;
                                                                ErrorText@1001 : Text[80];
                                                              BEGIN
                                                                if not Attachment.GET("Attachment No.") then
                                                                  exit;

                                                                ErrorText := Attachment.CheckCorrespondenceType("Correspondence Type");
                                                                if ErrorText <> '' then
                                                                  ERROR(
                                                                    STRSUBSTNO('%1%2',
                                                                      STRSUBSTNO(Text000,FIELDCAPTION("Correspondence Type"),"Correspondence Type",TABLECAPTION,"Line No."),
                                                                      ErrorText));
                                                              END;

                                                   CaptionML=ENU=Correspondence Type;
                                                   OptionCaptionML=ENU=" ,Hard Copy,Email,Fax";
                                                   OptionString=" ","Hard Copy",Email,Fax }
    { 7   ;   ;Interaction Template Code;Code10   ;TableRelation="Interaction Template";
                                                   OnValidate=VAR
                                                                SegInteractLanguage@1001 : Record "Segment Interaction Language";
                                                                InteractTemplLanguage@1002 : Record "Interaction Tmpl. Language";
                                                                InteractTmpl@1003 : Record "Interaction Template";
                                                              BEGIN
                                                                TESTFIELD("Contact No.");
                                                                Cont.GET("Contact No.");
                                                                "Attachment No." := 0;
                                                                "Language Code" := '';
                                                                Subject := '';
                                                                "Correspondence Type" := "Correspondence Type"::" ";
                                                                "Interaction Group Code" := '';
                                                                "Cost (LCY)" := 0;
                                                                "Duration (Min.)" := 0;
                                                                "Information Flow" := "Information Flow"::" ";
                                                                "Initiated By" := "Initiated By"::" ";
                                                                "Campaign Target" := false;
                                                                "Campaign Response" := false;
                                                                "Correspondence Type" := "Correspondence Type"::" ";
                                                                if (GETFILTER("Campaign No.") = '') and (InteractTmpl."Campaign No." <> '') then
                                                                  "Campaign No." := '';
                                                                MODIFY;

                                                                if "Segment No." <> '' then begin
                                                                  SegInteractLanguage.RESET;
                                                                  SegInteractLanguage.SETRANGE("Segment No.","Segment No.");
                                                                  SegInteractLanguage.SETRANGE("Segment Line No.","Line No.");
                                                                  SegInteractLanguage.DELETEALL(true);
                                                                  GET("Segment No.","Line No.");
                                                                  if "Interaction Template Code" <> '' then begin
                                                                    SegHeader.GET("Segment No.");
                                                                    if "Interaction Template Code" <> SegHeader."Interaction Template Code" then begin
                                                                      SegHeader.CreateSegInteractions("Interaction Template Code","Segment No.","Line No.");
                                                                      "Language Code" := FindLanguage("Interaction Template Code",Cont."Language Code");
                                                                      if SegInteractLanguage.GET("Segment No.","Line No.","Language Code") then
                                                                        "Attachment No." := SegInteractLanguage."Attachment No.";
                                                                    end else begin
                                                                      "Language Code" := FindLanguage("Interaction Template Code",Cont."Language Code");
                                                                      if SegInteractLanguage.GET("Segment No.",0,"Language Code") then
                                                                        "Attachment No." := SegInteractLanguage."Attachment No.";
                                                                    end;
                                                                  end;
                                                                end else begin
                                                                  "Language Code" := FindLanguage("Interaction Template Code",Cont."Language Code");
                                                                  if InteractTemplLanguage.GET("Interaction Template Code","Language Code") then
                                                                    "Attachment No." := InteractTemplLanguage."Attachment No.";
                                                                end;

                                                                if InteractTmpl.GET("Interaction Template Code") then begin
                                                                  "Interaction Group Code" := InteractTmpl."Interaction Group Code";
                                                                  if Description = '' then
                                                                    Description := InteractTmpl.Description;
                                                                  if EmailDraftLogging then begin
                                                                    Subject := GetEmailDraftSubject;
                                                                    Description := EmailDraftTxt;
                                                                  end;
                                                                  "Cost (LCY)" := InteractTmpl."Unit Cost (LCY)";
                                                                  "Duration (Min.)" := InteractTmpl."Unit Duration (Min.)";
                                                                  "Information Flow" := InteractTmpl."Information Flow";
                                                                  "Initiated By" := InteractTmpl."Initiated By";
                                                                  "Campaign Target" := InteractTmpl."Campaign Target";
                                                                  "Campaign Response" := InteractTmpl."Campaign Response";

                                                                  case true of
                                                                    SegHeader."Ignore Contact Corres. Type" and
                                                                    (SegHeader."Correspondence Type (Default)" <> SegHeader."Correspondence Type (Default)"::" "):
                                                                      "Correspondence Type" := SegHeader."Correspondence Type (Default)";
                                                                    InteractTmpl."Ignore Contact Corres. Type" or
                                                                    ((InteractTmpl."Ignore Contact Corres. Type" = false) and
                                                                     (Cont."Correspondence Type" = Cont."Correspondence Type"::" ") and
                                                                     (InteractTmpl."Correspondence Type (Default)" <> InteractTmpl."Correspondence Type (Default)"::" ")):
                                                                      "Correspondence Type" := InteractTmpl."Correspondence Type (Default)";
                                                                    else
                                                                      if Cont."Correspondence Type" <> Cont."Correspondence Type"::" " then
                                                                        "Correspondence Type" := Cont."Correspondence Type"
                                                                      else
                                                                        "Correspondence Type" := xRec."Correspondence Type";
                                                                  end;
                                                                  if SegHeader."Campaign No." <> '' then
                                                                    "Campaign No." := SegHeader."Campaign No."
                                                                  else
                                                                    if (GETFILTER("Campaign No.") = '') and (InteractTmpl."Campaign No." <> '') then
                                                                      "Campaign No." := InteractTmpl."Campaign No.";
                                                                end;
                                                                if Campaign.GET("Campaign No.") then
                                                                  "Campaign Description" := Campaign.Description;

                                                                MODIFY;
                                                              END;

                                                   CaptionML=ENU=Interaction Template Code }
    { 8   ;   ;Cost (LCY)          ;Decimal       ;CaptionML=ENU=Cost (LCY);
                                                   MinValue=0;
                                                   AutoFormatType=1 }
    { 9   ;   ;Duration (Min.)     ;Decimal       ;CaptionML=ENU=Duration (Min.);
                                                   DecimalPlaces=0:0;
                                                   MinValue=0 }
    { 10  ;   ;Attachment No.      ;Integer       ;TableRelation=Attachment;
                                                   CaptionML=ENU=Attachment No. }
    { 11  ;   ;Campaign Response   ;Boolean       ;CaptionML=ENU=Campaign Response }
    { 12  ;   ;Contact Name        ;Text50        ;FieldClass=FlowField;
                                                   CalcFormula=Lookup(Contact.Name WHERE ("No."=FIELD("Contact No."),
                                                                                          Type=CONST(Person)));
                                                   CaptionML=ENU=Contact Name;
                                                   Editable=false }
    { 13  ;   ;Information Flow    ;Option        ;CaptionML=ENU=Information Flow;
                                                   OptionCaptionML=ENU=" ,Outbound,Inbound";
                                                   OptionString=" ",Outbound,Inbound;
                                                   BlankZero=true }
    { 14  ;   ;Initiated By        ;Option        ;CaptionML=ENU=Initiated By;
                                                   OptionCaptionML=ENU=" ,Us,Them";
                                                   OptionString=" ",Us,Them;
                                                   BlankZero=true }
    { 15  ;   ;Contact Alt. Address Code;Code10   ;TableRelation="Contact Alt. Address".Code WHERE ("Contact No."=FIELD("Contact No."));
                                                   CaptionML=ENU=Contact Alt. Address Code }
    { 16  ;   ;Evaluation          ;Option        ;CaptionML=ENU=Evaluation;
                                                   OptionCaptionML=ENU=" ,Very Positive,Positive,Neutral,Negative,Very Negative";
                                                   OptionString=" ","Very Positive",Positive,Neutral,Negative,"Very Negative" }
    { 17  ;   ;Campaign Target     ;Boolean       ;OnValidate=BEGIN
                                                                if xRec."Campaign Target" <> "Campaign Target" then
                                                                  SetCampaignTargetGroup;
                                                              END;

                                                   CaptionML=ENU=Campaign Target }
    { 18  ;   ;Contact Company Name;Text50        ;FieldClass=FlowField;
                                                   CalcFormula=Lookup(Contact.Name WHERE ("No."=FIELD("Contact Company No."),
                                                                                          Type=CONST(Company)));
                                                   CaptionML=ENU=Contact Company Name;
                                                   Editable=false }
    { 19  ;   ;Language Code       ;Code10        ;TableRelation=Language;
                                                   OnValidate=VAR
                                                                SegInteractLanguage@1002 : Record "Segment Interaction Language";
                                                                InteractTemplLanguage@1001 : Record "Interaction Tmpl. Language";
                                                              BEGIN
                                                                TESTFIELD("Interaction Template Code");

                                                                if "Language Code" = xRec."Language Code" then
                                                                  exit;

                                                                if SegHeader.GET("Segment No.") then begin
                                                                  if not UniqueAttachmentExists then begin
                                                                    if SegInteractLanguage.GET("Segment No.",0,"Language Code") then begin
                                                                      "Attachment No." := SegInteractLanguage."Attachment No.";
                                                                      Subject := SegInteractLanguage.Subject;
                                                                    end else begin
                                                                      "Attachment No." := 0;
                                                                      Subject := '';
                                                                    end;
                                                                  end else
                                                                    if SegInteractLanguage.GET("Segment No.","Line No.","Language Code") then begin
                                                                      "Attachment No." := SegInteractLanguage."Attachment No.";
                                                                      Subject := SegInteractLanguage.Subject;
                                                                    end else begin
                                                                      "Attachment No." := 0;
                                                                      Subject := '';
                                                                    end;
                                                                  MODIFY;
                                                                end else begin
                                                                  InteractTemplLanguage.GET("Interaction Template Code","Language Code");
                                                                  SetInteractionAttachment;
                                                                end;
                                                              END;

                                                   OnLookup=BEGIN
                                                              LanguageCodeOnLookup;
                                                            END;

                                                   CaptionML=ENU=Language Code }
    { 22  ;   ;Description         ;Text50        ;CaptionML=ENU=Description }
    { 23  ;   ;Date                ;Date          ;OnValidate=BEGIN
                                                                if Cont.GET("Contact No.") then
                                                                  if "Contact Alt. Address Code" = Cont.ActiveAltAddress(xRec.Date) then
                                                                    "Contact Alt. Address Code" := Cont.ActiveAltAddress(Date);
                                                              END;

                                                   CaptionML=ENU=Date }
    { 24  ;   ;Time of Interaction ;Time          ;CaptionML=ENU=Time of Interaction }
    { 25  ;   ;Attempt Failed      ;Boolean       ;CaptionML=ENU=Attempt Failed }
    { 26  ;   ;To-do No.           ;Code20        ;TableRelation="To-do";
                                                   CaptionML=ENU=Task No. }
    { 27  ;   ;Contact Company No. ;Code20        ;TableRelation=Contact WHERE (Type=CONST(Company));
                                                   CaptionML=ENU=Contact Company No. }
    { 28  ;   ;Campaign Entry No.  ;Integer       ;TableRelation="Campaign Entry";
                                                   CaptionML=ENU=Campaign Entry No.;
                                                   Editable=false }
    { 29  ;   ;Interaction Group Code;Code10      ;TableRelation="Interaction Group";
                                                   CaptionML=ENU=Interaction Group Code }
    { 31  ;   ;Document Type       ;Option        ;CaptionML=ENU=Document Type;
                                                   OptionCaptionML=ENU=" ,Sales Qte.,Sales Blnkt. Ord,Sales Ord. Cnfrmn.,Sales Inv.,Sales Shpt. Note,Sales Cr. Memo,Sales Stmnt.,Sales Rmdr.,Serv. Ord. Create,Serv. Ord. Post,Purch.Qte.,Purch. Blnkt. Ord.,Purch. Ord.,Purch. Inv.,Purch. Rcpt.,Purch. Cr. Memo,Cover Sheet";
                                                   OptionString=" ","Sales Qte.","Sales Blnkt. Ord","Sales Ord. Cnfrmn.","Sales Inv.","Sales Shpt. Note","Sales Cr. Memo","Sales Stmnt.","Sales Rmdr.","Serv. Ord. Create","Serv. Ord. Post","Purch.Qte.","Purch. Blnkt. Ord.","Purch. Ord.","Purch. Inv.","Purch. Rcpt.","Purch. Cr. Memo","Cover Sheet" }
    { 32  ;   ;Document No.        ;Code20        ;TestTableRelation=false;
                                                   CaptionML=ENU=Document No. }
    { 33  ;   ;Send Word Doc. As Attmt.;Boolean   ;CaptionML=ENU=Send Word Doc. As Attmt. }
    { 34  ;   ;Contact Via         ;Text80        ;CaptionML=ENU=Contact Via }
    { 35  ;   ;Version No.         ;Integer       ;CaptionML=ENU=Version No. }
    { 36  ;   ;Doc. No. Occurrence ;Integer       ;CaptionML=ENU=Doc. No. Occurrence }
    { 37  ;   ;Subject             ;Text50        ;CaptionML=ENU=Subject }
    { 44  ;   ;Opportunity No.     ;Code20        ;TableRelation=Opportunity;
                                                   CaptionML=ENU=Opportunity No. }
    { 9501;   ;Wizard Step         ;Option        ;CaptionML=ENU=Wizard Step;
                                                   OptionCaptionML=ENU=" ,1,2,3,4,5,6";
                                                   OptionString=" ","1","2","3","4","5","6";
                                                   Editable=false }
    { 9502;   ;Wizard Contact Name ;Text50        ;CaptionML=ENU=Wizard Contact Name }
    { 9503;   ;Opportunity Description;Text50     ;CaptionML=ENU=Opportunity Description }
    { 9504;   ;Campaign Description;Text50        ;CaptionML=ENU=Campaign Description }
    { 9505;   ;Interaction Successful;Boolean     ;CaptionML=ENU=Interaction Successful }
    { 9506;   ;Dial Contact        ;Boolean       ;CaptionML=ENU=Dial Contact }
    { 9507;   ;Mail Contact        ;Boolean       ;CaptionML=ENU=Mail Contact }
  }
  KEYS
  {
    {    ;"Segment No.","Line No."                ;SumIndexFields="Cost (LCY)","Duration (Min.)";
                                                   Clustered=true }
    {    ;"Segment No.","Campaign No.",Date        }
    {    ;"Contact No.","Segment No."              }
    {    ;"Campaign No."                           }
    {    ;"Campaign No.","Contact Company No.","Campaign Target" }
  }
  FIELDGROUPS
  {
  }
  CODE
  {
    VAR
      Text000@1000 : TextConst 'ENU="%1 = %2 can not be specified for %3 %4.\"';
      Text001@1001 : TextConst 'ENU=Inherited';
      Text002@1002 : TextConst 'ENU=Unique';
      SegHeader@1006 : Record "Segment Header";
      Cont@1007 : Record Contact;
      Salesperson@1008 : Record "Salesperson/Purchaser";
      Campaign@1013 : Record Campaign;
      InteractTmpl@1003 : Record "Interaction Template";
      Attachment@1005 : Record Attachment;
      TempAttachment@1004 : TEMPORARY Record Attachment;
      InterLogEntryCommentLine@1017 : Record "Inter. Log Entry Comment Line";
      TempInterLogEntryCommentLine@1018 : TEMPORARY Record "Inter. Log Entry Comment Line";
      AttachmentManagement@1010 : Codeunit AttachmentManagement;
      Text005@1023 : TextConst 'ENU=You must fill in the %1 field.';
      Text004@1012 : TextConst 'ENU=The program has stopped importing the attachment at your request.';
      Text006@1011 : TextConst 'ENU=Your Segment is now empty.\Do you want to reset number of criteria actions?';
      CampaignTargetGrMgt@1014 : Codeunit "Campaign Target Group Mgt";
      Mail@1020 : Codeunit Mail;
      ResumedAttachmentNo@1015 : Integer;
      Text007@1016 : TextConst 'ENU=Do you want to finish this interaction later?';
      Text008@1022 : TextConst 'ENU=You must select an interaction template with an attachment.';
      Text009@1025 : TextConst 'ENU=You must select a contact to interact with.';
      Text013@1024 : TextConst 'ENU=You must fill in the phone number.';
      Text024@1032 : TextConst '@@@="%1=Correspondence Type";ENU="%1 = %2 cannot be specified."';
      Text025@1033 : TextConst '@@@=%2 - product name;ENU=The email could not be sent because of the following error: %1.\Note: if you run %2 as administrator, you must run Outlook as administrator as well.';
      EmailDraftTxt@1019 : TextConst 'ENU=Email Draft';

    [External]
    PROCEDURE InitLine@1();
    BEGIN
      if SegHeader.GET("Segment No.") then begin
        Description := SegHeader.Description;
        "Campaign No." := SegHeader."Campaign No.";
        "Salesperson Code" := SegHeader."Salesperson Code";
        "Correspondence Type" := SegHeader."Correspondence Type (Default)";
        "Interaction Template Code" := SegHeader."Interaction Template Code";
        "Interaction Group Code" := SegHeader."Interaction Group Code";
        "Cost (LCY)" := SegHeader."Unit Cost (LCY)";
        "Duration (Min.)" := SegHeader."Unit Duration (Min.)";
        "Attachment No." := SegHeader."Attachment No.";
        Date := SegHeader.Date;
        "Campaign Target" := SegHeader."Campaign Target";
        "Information Flow" := SegHeader."Information Flow";
        "Initiated By" := SegHeader."Initiated By";
        "Campaign Response" := SegHeader."Campaign Response";
        "Send Word Doc. As Attmt." := SegHeader."Send Word Docs. as Attmt.";
        CLEAR(Evaluation);
      end;
    END;

    [External]
    PROCEDURE AttachmentText@5() : Text[30];
    BEGIN
      if AttachmentInherited then
        exit(Text001);

      if "Attachment No." <> 0 then
        exit(Text002);

      exit('');
    END;

    [Internal]
    PROCEDURE MaintainAttachment@9();
    VAR
      Cont@1000 : Record Contact;
      SalutationFormula@1001 : Record "Salutation Formula";
    BEGIN
      TESTFIELD("Interaction Template Code");

      Cont.GET("Contact No.");
      if SalutationFormula.GET(Cont."Salutation Code","Language Code",0) then;
      if SalutationFormula.GET(Cont."Salutation Code","Language Code",1) then;

      if "Attachment No." <> 0 then
        OpenAttachment
      else
        CreateAttachment;
    END;

    [Internal]
    PROCEDURE CreateAttachment@8();
    VAR
      SegInteractLanguage@1003 : Record "Segment Interaction Language";
    BEGIN
      if not SegInteractLanguage.GET("Segment No.","Line No.","Language Code") then begin
        SegInteractLanguage.INIT;
        SegInteractLanguage."Segment No." := "Segment No.";
        SegInteractLanguage."Segment Line No." := "Line No.";
        SegInteractLanguage."Language Code" := "Language Code";
        SegInteractLanguage.Description := Description;
        SegInteractLanguage.Subject := Subject;
      end;

      SegInteractLanguage.CreateAttachment;
    END;

    [Internal]
    PROCEDURE OpenAttachment@2();
    VAR
      Attachment@1004 : Record Attachment;
      Attachment2@1003 : Record Attachment;
      SegInteractLanguage@1002 : Record "Segment Interaction Language";
      NewAttachmentNo@1000 : Integer;
    BEGIN
      if "Attachment No." = 0 then
        exit;

      Attachment.GET("Attachment No.");
      Attachment2 := Attachment;

      Attachment2.ShowAttachment(Rec,"Segment No." + ' ' + Description,false,true);

      if AttachmentInherited then begin
        NewAttachmentNo := Attachment2."No.";
        if (Attachment."Last Date Modified" <> Attachment2."Last Date Modified") or
           (Attachment."Last Time Modified" <> Attachment2."Last Time Modified")
        then begin
          SegInteractLanguage.INIT;
          SegInteractLanguage."Segment No." := "Segment No.";
          SegInteractLanguage."Segment Line No." := "Line No.";
          SegInteractLanguage."Language Code" := "Language Code";
          SegInteractLanguage.Description := Description;
          SegInteractLanguage.Subject := Subject;
          SegInteractLanguage."Attachment No." := NewAttachmentNo;
          SegInteractLanguage.INSERT(true);
          GET("Segment No.","Line No.");
          "Attachment No." := NewAttachmentNo;
          MODIFY;
        end;
      end
    END;

    [Internal]
    PROCEDURE ImportAttachment@3();
    VAR
      SegInteractLanguage@1003 : Record "Segment Interaction Language";
    BEGIN
      if not SegInteractLanguage.GET("Segment No.","Line No.","Language Code") then begin
        SegInteractLanguage.INIT;
        SegInteractLanguage."Segment No." := "Segment No.";
        SegInteractLanguage."Segment Line No." := "Line No.";
        SegInteractLanguage."Language Code" := "Language Code";
        SegInteractLanguage.Description := Description;
        SegInteractLanguage.INSERT(true);
      end;
      SegInteractLanguage.ImportAttachment;
    END;

    [Internal]
    PROCEDURE ExportAttachment@4();
    VAR
      SegInteractLanguage@1000 : Record "Segment Interaction Language";
    BEGIN
      if UniqueAttachmentExists then begin
        if SegInteractLanguage.GET("Segment No.","Line No.","Language Code") then
          if SegInteractLanguage."Attachment No." <> 0 then
            SegInteractLanguage.ExportAttachment;
      end else
        if SegInteractLanguage.GET("Segment No.",0,"Language Code") then
          if SegInteractLanguage."Attachment No." <> 0 then
            SegInteractLanguage.ExportAttachment;
    END;

    [External]
    PROCEDURE RemoveAttachment@7();
    VAR
      SegInteractLanguage@1002 : Record "Segment Interaction Language";
    BEGIN
      if SegInteractLanguage.GET("Segment No.","Line No.","Language Code") then begin
        SegInteractLanguage.DELETE(true);
        GET("Segment No.","Line No.");
      end;
      "Attachment No." := 0;
    END;

    [External]
    PROCEDURE CreatePhoneCall@21();
    VAR
      TempSegmentLine@1000 : TEMPORARY Record "Segment Line";
    BEGIN
      Cont.GET("Contact No.");
      TempSegmentLine."Contact No." := Cont."No.";
      TempSegmentLine."Contact Via" := Cont."Phone No.";
      TempSegmentLine."Contact Company No." := Cont."Company No.";
      TempSegmentLine."To-do No." := "To-do No.";
      TempSegmentLine."Salesperson Code" := "Salesperson Code";
      if "Contact Alt. Address Code" <> '' then
        TempSegmentLine."Contact Alt. Address Code" := "Contact Alt. Address Code";
      if "Campaign No." <> '' then
        TempSegmentLine."Campaign No." := "Campaign No.";

      TempSegmentLine."Campaign Target" := "Campaign Target";
      TempSegmentLine."Campaign Response" := "Campaign Response";
      TempSegmentLine.SETRANGE("Contact No.",TempSegmentLine."Contact No.");
      TempSegmentLine.SETRANGE("Campaign No.",TempSegmentLine."Campaign No.");

      TempSegmentLine.StartWizard2;
    END;

    LOCAL PROCEDURE FindLanguage@10(InteractTmplCode@1001 : Code[10];ContactLanguageCode@1000 : Code[10]) Language@1005 : Code[10];
    VAR
      SegInteractLanguage@1004 : Record "Segment Interaction Language";
      InteractTemplLanguage@1003 : Record "Interaction Tmpl. Language";
      InteractTmpl@1002 : Record "Interaction Template";
    BEGIN
      if SegHeader.GET("Segment No.") then begin
        if not UniqueAttachmentExists and
           ("Interaction Template Code" = SegHeader."Interaction Template Code")
        then begin
          if SegInteractLanguage.GET("Segment No.",0,ContactLanguageCode) then
            Language := ContactLanguageCode
          else
            Language := SegHeader."Language Code (Default)";
        end else
          if SegInteractLanguage.GET("Segment No.","Line No.",ContactLanguageCode) then
            Language := ContactLanguageCode
          else begin
            InteractTmpl.GET(InteractTmplCode);
            if SegInteractLanguage.GET("Segment No.","Line No.",InteractTmpl."Language Code (Default)") then
              Language := InteractTmpl."Language Code (Default)"
            else begin
              SegInteractLanguage.SETRANGE("Segment No.","Segment No.");
              SegInteractLanguage.SETRANGE("Segment Line No.","Line No.");
              if SegInteractLanguage.FINDFIRST then
                Language := SegInteractLanguage."Language Code";
            end;
          end;
      end else begin  // Create Interaction:
        if InteractTemplLanguage.GET(InteractTmplCode,ContactLanguageCode) then
          Language := ContactLanguageCode
        else
          if InteractTmpl.GET(InteractTmplCode) then
            Language := InteractTmpl."Language Code (Default)";
      end;
    END;

    PROCEDURE AttachmentInherited@12() : Boolean;
    VAR
      SegInteractLanguage@1000 : Record "Segment Interaction Language";
    BEGIN
      if "Attachment No." = 0 then
        exit(false);
      if not SegHeader.GET("Segment No.") then
        exit(false);
      if "Interaction Template Code" = '' then
        exit(false);

      SegInteractLanguage.SETRANGE("Segment No.","Segment No.");
      SegInteractLanguage.SETRANGE("Segment Line No.","Line No.");
      SegInteractLanguage.SETRANGE("Language Code","Language Code");
      SegInteractLanguage.SETRANGE("Attachment No.","Attachment No.");
      if not SegInteractLanguage.ISEMPTY then
        exit(false);

      SegInteractLanguage.SETRANGE("Segment Line No.",0);
      exit(not SegInteractLanguage.ISEMPTY);
    END;

    [External]
    PROCEDURE SetInteractionAttachment@13();
    VAR
      Attachment@1001 : Record Attachment;
      InteractTemplLanguage@1000 : Record "Interaction Tmpl. Language";
    BEGIN
      if InteractTemplLanguage.GET("Interaction Template Code","Language Code") then begin
        if Attachment.GET(InteractTemplLanguage."Attachment No.") then
          "Attachment No." := InteractTemplLanguage."Attachment No."
        else
          "Attachment No." := 0;
      end;
      MODIFY;
    END;

    LOCAL PROCEDURE UniqueAttachmentExists@14() : Boolean;
    VAR
      SegInteractLanguage@1000 : Record "Segment Interaction Language";
    BEGIN
      if "Line No." <> 0 then begin
        SegInteractLanguage.SETRANGE("Segment No.","Segment No.");
        SegInteractLanguage.SETRANGE("Segment Line No.","Line No.");
        exit(not SegInteractLanguage.ISEMPTY);
      end;
      exit(false);
    END;

    LOCAL PROCEDURE SetCampaignTargetGroup@15();
    BEGIN
      if Campaign.GET(xRec."Campaign No.") then begin
        Campaign.CALCFIELDS(Activated);
        if Campaign.Activated then
          CampaignTargetGrMgt.DeleteSegfromTargetGr(xRec);
      end;

      if Campaign.GET("Campaign No.") then begin
        Campaign.CALCFIELDS(Activated);
        if Campaign.Activated then
          CampaignTargetGrMgt.AddSegLinetoTargetGr(Rec);
      end;
    END;

    [External]
    PROCEDURE CopyFromInteractLogEntry@52(VAR InteractLogEntry@1001 : Record "Interaction Log Entry");
    BEGIN
      "Line No." := InteractLogEntry."Entry No.";
      "Contact No." := InteractLogEntry."Contact No.";
      "Contact Company No." := InteractLogEntry."Contact Company No.";
      Date := InteractLogEntry.Date;
      Description := InteractLogEntry.Description;
      "Information Flow" := InteractLogEntry."Information Flow";
      "Initiated By" := InteractLogEntry."Initiated By";
      "Attachment No." := InteractLogEntry."Attachment No.";
      "Cost (LCY)" := InteractLogEntry."Cost (LCY)";
      "Duration (Min.)" := InteractLogEntry."Duration (Min.)";
      "Interaction Group Code" := InteractLogEntry."Interaction Group Code";
      "Interaction Template Code" := InteractLogEntry."Interaction Template Code";
      "Language Code" := InteractLogEntry."Interaction Language Code";
      Subject := InteractLogEntry.Subject;
      "Campaign No." := InteractLogEntry."Campaign No.";
      "Campaign Entry No." := InteractLogEntry."Campaign Entry No.";
      "Campaign Response" := InteractLogEntry."Campaign Response";
      "Campaign Target" := InteractLogEntry."Campaign Target";
      "Segment No." := InteractLogEntry."Segment No.";
      Evaluation := InteractLogEntry.Evaluation;
      "Time of Interaction" := InteractLogEntry."Time of Interaction";
      "Attempt Failed" := InteractLogEntry."Attempt Failed";
      "To-do No." := InteractLogEntry."To-do No.";
      "Salesperson Code" := InteractLogEntry."Salesperson Code";
      "Correspondence Type" := InteractLogEntry."Correspondence Type";
      "Contact Alt. Address Code" := InteractLogEntry."Contact Alt. Address Code";
      "Document Type" := InteractLogEntry."Document Type";
      "Document No." := InteractLogEntry."Document No.";
      "Doc. No. Occurrence" := InteractLogEntry."Doc. No. Occurrence";
      "Version No." := InteractLogEntry."Version No.";
      "Send Word Doc. As Attmt." := InteractLogEntry."Send Word Docs. as Attmt.";
      "Contact Via" := InteractLogEntry."Contact Via";
      "Opportunity No." := InteractLogEntry."Opportunity No.";
    END;

    PROCEDURE CreateInteractionFromContact@38(VAR Contact@1000 : Record Contact);
    BEGIN
      DELETEALL;
      INIT;
      if Contact.Type = Contact.Type::Person then
        SETRANGE("Contact Company No.",Contact."Company No.");
      SETRANGE("Contact No.",Contact."No.");
      VALIDATE("Contact No.",Contact."No.");

      "Salesperson Code" := FindSalespersonByUserEmail;
      if "Salesperson Code" = '' then
        "Salesperson Code" := Contact."Salesperson Code";
      StartWizard;
    END;

    [External]
    PROCEDURE CreateInteractionFromSalesperson@39(VAR Salesperson@1000 : Record "Salesperson/Purchaser");
    BEGIN
      DELETEALL;
      INIT;
      VALIDATE("Salesperson Code",Salesperson.Code);
      SETRANGE("Salesperson Code",Salesperson.Code);
      StartWizard;
    END;

    [External]
    PROCEDURE CreateInteractionFromInteractLogEntry@42(VAR InteractionLogEntry@1000 : Record "Interaction Log Entry");
    VAR
      Cont@1005 : Record Contact;
      Salesperson@1004 : Record "Salesperson/Purchaser";
      Campaign@1003 : Record Campaign;
      Task@1002 : Record "To-do";
      Opportunity@1001 : Record Opportunity;
    BEGIN
      if Task.GET(InteractionLogEntry.GETFILTER("To-do No.")) then begin
        CreateFromTask(Task);
        SETRANGE("To-do No.","To-do No.");
      end else begin
        if Cont.GET(InteractionLogEntry.GETFILTER("Contact Company No.")) then begin
          VALIDATE("Contact No.",Cont."Company No.");
          SETRANGE("Contact No.","Contact No.");
        end;
        if Cont.GET(InteractionLogEntry.GETFILTER("Contact No.")) then begin
          VALIDATE("Contact No.",Cont."No.");
          SETRANGE("Contact No.","Contact No.");
        end;
        if Salesperson.GET(InteractionLogEntry.GETFILTER("Salesperson Code")) then begin
          "Salesperson Code" := Salesperson.Code;
          SETRANGE("Salesperson Code","Salesperson Code");
        end;
        if Campaign.GET(InteractionLogEntry.GETFILTER("Campaign No.")) then begin
          "Campaign No." := Campaign."No.";
          SETRANGE("Campaign No.","Campaign No.");
        end;
        if Opportunity.GET(InteractionLogEntry.GETFILTER("Opportunity No.")) then begin
          "Opportunity No." := Opportunity."No.";
          SETRANGE("Opportunity No.","Opportunity No.");
        end;
      end;
      StartWizard;
    END;

    [External]
    PROCEDURE CreateInteractionFromTask@43(VAR Task@1000 : Record "To-do");
    BEGIN
      INIT;
      CreateFromTask(Task);
      SETRANGE("To-do No.","To-do No.");
      StartWizard;
    END;

    [External]
    PROCEDURE CreateInteractionFromOpp@129(VAR Opportunity@1000 : Record Opportunity);
    VAR
      Contact@1001 : Record Contact;
      Salesperson@1002 : Record "Salesperson/Purchaser";
      Campaign@1003 : Record Campaign;
    BEGIN
      INIT;
      if Contact.GET(Opportunity."Contact Company No.") then begin
        VALIDATE("Contact No.",Contact."Company No.");
        SETRANGE("Contact No.","Contact No.");
      end;
      if Contact.GET(Opportunity."Contact No.") then begin
        VALIDATE("Contact No.",Contact."No.");
        SETRANGE("Contact No.","Contact No.");
      end;
      if Salesperson.GET(Opportunity."Salesperson Code") then begin
        VALIDATE("Salesperson Code",Salesperson.Code);
        SETRANGE("Salesperson Code","Salesperson Code");
      end;
      if Campaign.GET(Opportunity."Campaign No.") then begin
        VALIDATE("Campaign No.",Campaign."No.");
        SETRANGE("Campaign No.","Campaign No.");
      end;
      VALIDATE("Opportunity No.",Opportunity."No.");
      SETRANGE("Opportunity No.","Opportunity No.");
      StartWizard;
    END;

    [External]
    PROCEDURE CreateOpportunity@32() : Code[20];
    VAR
      Opportunity@1000 : Record Opportunity;
    BEGIN
      Opportunity.CreateFromSegmentLine(Rec);
      exit(Opportunity."No.");
    END;

    LOCAL PROCEDURE CreateFromTask@37(Task@1000 : Record "To-do");
    BEGIN
      "To-do No." := Task."No.";
      VALIDATE("Contact No.",Task."Contact No.");
      "Salesperson Code" := Task."Salesperson Code";
      "Campaign No." := Task."Campaign No.";
      "Opportunity No." := Task."Opportunity No.";
    END;

    LOCAL PROCEDURE GetContactName@41() : Text[50];
    VAR
      Cont@1000 : Record Contact;
    BEGIN
      if Cont.GET("Contact No.") then
        exit(Cont.Name);
      if Cont.GET("Contact Company No.") then
        exit(Cont.Name);
    END;

    [External]
    PROCEDURE StartWizard@33();
    VAR
      Opp@1000 : Record Opportunity;
      RelationshipPerformanceMgt@1001 : Codeunit "Relationship Performance Mgt.";
    BEGIN
      if Campaign.GET("Campaign No.") then
        "Campaign Description" := Campaign.Description;
      if Opp.GET("Opportunity No.") then
        "Opportunity Description" := Opp.Description;
      "Wizard Contact Name" := GetContactName;
      "Wizard Step" := "Wizard Step"::"1";
      "Interaction Successful" := true;
      VALIDATE(Date,WORKDATE);
      "Time of Interaction" := DT2TIME(ROUNDDATETIME(CURRENTDATETIME + 1000,60000,'>'));
      INSERT;

      if PAGE.RUNMODAL(PAGE::"Create Interaction",Rec,"Interaction Template Code") = ACTION::OK then;
      if "Wizard Step" = "Wizard Step"::"6" then
        RelationshipPerformanceMgt.SendCreateOpportunityNotification(Rec);
    END;

    [Internal]
    PROCEDURE CheckStatus@16();
    VAR
      InteractTmpl@1000 : Record "Interaction Template";
      Attachment@1001 : Record Attachment;
      SalutationFormula@1002 : Record "Salutation Formula";
    BEGIN
      if "Contact No." = '' then
        ERROR(Text009);
      if "Interaction Template Code" = '' then
        ErrorMessage(FIELDCAPTION("Interaction Template Code"));
      if "Salesperson Code" = '' then
        ErrorMessage(FIELDCAPTION("Salesperson Code"));
      if Date = 0D then
        ErrorMessage(FIELDCAPTION(Date));
      if Description = '' then
        ErrorMessage(FIELDCAPTION(Description));

      InteractTmpl.GET("Interaction Template Code");
      if InteractTmpl."Wizard Action" = InteractTmpl."Wizard Action"::Open then
        if "Attachment No." = 0 then
          ErrorMessage(Attachment.TABLECAPTION);

      Cont.GET("Contact No.");
      if SalutationFormula.GET(Cont."Salutation Code","Language Code",0) then;
      if SalutationFormula.GET(Cont."Salutation Code","Language Code",1) then;

      if TempAttachment.FINDFIRST then
        TempAttachment.CALCFIELDS("Attachment File");
      if ("Correspondence Type" = "Correspondence Type"::Email) and
         not TempAttachment."Attachment File".HASVALUE
      then
        ERROR(Text008);
    END;

    PROCEDURE FinishWizard@18(IsFinish@1000 : Boolean);
    VAR
      InteractionLogEntry@1003 : Record "Interaction Log Entry";
      SegManagement@1002 : Codeunit SegManagement;
      send@1001 : Boolean;
      Flag@1102601000 : Boolean;
      HTMLAttachment@1006 : Boolean;
      HTMLContentBodyText@1004 : Text;
      CustomLayoutCode@1005 : Code[20];
    BEGIN
      HTMLAttachment := IsHTMLAttachment;
      Flag := false;
      if IsFinish then
        Flag := true
      else
        Flag := CONFIRM(Text007);

      if Flag then begin
        CheckStatus;

        if "Opportunity No." = '' then
          "Wizard Step" := "Wizard Step"::"6";

        if not HTMLAttachment then
          HandleTrigger;

        "Attempt Failed" := not "Interaction Successful";
        Subject := Description;
        if not HTMLAttachment then
          ProcessPostponedAttachment;
        send := (IsFinish and ("Correspondence Type" <> "Correspondence Type"::" "));
        if send and HTMLAttachment then begin
          TempAttachment.ReadHTMLCustomLayoutAttachment(HTMLContentBodyText,CustomLayoutCode);
          AttachmentManagement.GenerateHTMLContent(TempAttachment,Rec);
        end;
        SegManagement.LogInteraction(Rec,TempAttachment,TempInterLogEntryCommentLine,send,not IsFinish);
        InteractionLogEntry.FINDLAST;
        if send and (InteractionLogEntry."Delivery Status" = InteractionLogEntry."Delivery Status"::Error) then begin
          if HTMLAttachment then begin
            CLEAR(TempAttachment);
            LoadTempAttachment(false);
            TempAttachment.WriteHTMLCustomLayoutAttachment(HTMLContentBodyText,CustomLayoutCode);
            COMMIT;
          end;
          if not (CURRENTCLIENTTYPE in [CLIENTTYPE::Web,CLIENTTYPE::Tablet,CLIENTTYPE::Phone]) then
            if Mail.GetErrorDesc <> '' then
              ERROR(Text025,Mail.GetErrorDesc,PRODUCTNAME.FULL);
        end;
      end
    END;

    LOCAL PROCEDURE ErrorMessage@17(FieldName@1000 : Text[1024]);
    BEGIN
      ERROR(Text005,FieldName);
    END;

    [External]
    PROCEDURE ValidateCorrespondenceType@47();
    VAR
      ErrorText@1000 : Text[80];
    BEGIN
      if "Correspondence Type" <> "Correspondence Type"::" " then
        if TempAttachment.FINDFIRST then begin
          ErrorText := TempAttachment.CheckCorrespondenceType("Correspondence Type");
          if ErrorText <> '' then
            ERROR(
              Text024 + ErrorText,
              FIELDCAPTION("Correspondence Type"),"Correspondence Type");
        end;
    END;

    LOCAL PROCEDURE HandleTrigger@20();
    VAR
      TempBlob@1005 : Record TempBlob;
      FileMgt@1003 : Codeunit "File Management";
      ImportedFileName@1000 : Text;
    BEGIN
      InteractTmpl.GET("Interaction Template Code");

      case InteractTmpl."Wizard Action" of
        InteractTmpl."Wizard Action"::" ":
          if "Attachment No." <> 0 then begin
            LoadTempAttachment(false);
            Subject := Description;
            TempAttachment.RunAttachment(Rec,Description,true,false,false);
          end;
        InteractTmpl."Wizard Action"::Open:
          begin
            TESTFIELD("Attachment No.");
            LoadTempAttachment(false);
            Subject := Description;
            TempAttachment.ShowAttachment(Rec,Description,true,false);
          end;
        InteractTmpl."Wizard Action"::Import:
          begin
            ImportedFileName := FileMgt.BLOBImport(TempBlob,ImportedFileName);
            if ImportedFileName = '' then
              MESSAGE(Text004)
            else begin
              TempAttachment.DELETEALL;
              TempAttachment."Attachment File" := TempBlob.Blob;
              TempAttachment."File Extension" := COPYSTR(FileMgt.GetExtension(ImportedFileName),1,250);
              TempAttachment.INSERT;
            end;
          end;
      end;
    END;

    LOCAL PROCEDURE LoadTempAttachment@22(ForceReload@1000 : Boolean);
    BEGIN
      if not ForceReload and TempAttachment."Attachment File".HASVALUE then
        exit;
      Attachment.GET("Attachment No.");
      Attachment.CALCFIELDS("Attachment File");
      TempAttachment.DELETEALL;
      TempAttachment.WizEmbeddAttachment(Attachment);
      TempAttachment."No." := 0;
      TempAttachment."Read Only" := false;
      if Attachment.IsHTML then
        TempAttachment."File Extension" := Attachment."File Extension";
      TempAttachment.INSERT;
    END;

    [External]
    PROCEDURE LoadContentBodyTextFromCustomLayoutAttachment@6() : Text;
    VAR
      ContentBodyText@1001 : Text;
      CustomLayoutCode@1000 : Code[20];
    BEGIN
      TempAttachment.ReadHTMLCustomLayoutAttachment(ContentBodyText,CustomLayoutCode);
      exit(ContentBodyText);
    END;

    [External]
    PROCEDURE UpdateContentBodyTextInCustomLayoutAttachment@28(NewContentBodyText@1007 : Text);
    VAR
      OldContentBodyText@1000 : Text;
      CustomLayoutCode@1001 : Code[20];
    BEGIN
      TempAttachment.FIND;
      TempAttachment.ReadHTMLCustomLayoutAttachment(OldContentBodyText,CustomLayoutCode);
      TempAttachment.WriteHTMLCustomLayoutAttachment(NewContentBodyText,CustomLayoutCode);
    END;

    LOCAL PROCEDURE ProcessPostponedAttachment@19();
    BEGIN
      if "Attachment No." <> 0 then begin
        LoadTempAttachment(false);
        if "Line No." <> 0 then
          "Attachment No." := ResumedAttachmentNo;
      end else
        if Attachment.GET(ResumedAttachmentNo) then
          Attachment.RemoveAttachment(false);
    END;

    PROCEDURE LoadAttachment@24(ForceReload@1000 : Boolean);
    BEGIN
      if "Line No." <> 0 then begin
        InterLogEntryCommentLine.SETRANGE("Entry No.","Line No.");
        if InterLogEntryCommentLine.FIND('-') then
          repeat
            TempInterLogEntryCommentLine.INIT;
            TempInterLogEntryCommentLine.TRANSFERFIELDS(InterLogEntryCommentLine,false);
            TempInterLogEntryCommentLine."Line No." := InterLogEntryCommentLine."Line No.";
            TempInterLogEntryCommentLine.INSERT;
          until InterLogEntryCommentLine.NEXT = 0;
        ResumedAttachmentNo := "Attachment No.";
      end;
      if "Attachment No." <> 0 then
        LoadTempAttachment(ForceReload)
      else begin
        TempAttachment.DELETEALL;
        CLEAR(TempAttachment);
      end;
    END;

    [External]
    PROCEDURE MakePhoneCallFromContact@45(VAR Cont@1000 : Record Contact;Task@1001 : Record "To-do";TableNo@1005 : Integer;PhoneNo@1003 : Text[30];ContAltAddrCode@1002 : Code[10]);
    BEGIN
      INIT;
      if Cont.Type = Cont.Type::Person then
        SETRANGE("Contact No.",Cont."No.")
      else
        SETRANGE("Contact Company No.",Cont."Company No.");
      if PhoneNo <> '' then
        "Contact Via" := PhoneNo
      else
        "Contact Via" := Cont."Phone No.";
      VALIDATE("Contact No.",Cont."No.");
      "Contact Name" := Cont.Name;
      VALIDATE(Date,TODAY);
      if ContAltAddrCode <> '' then
        "Contact Alt. Address Code" := ContAltAddrCode;
      if TableNo = DATABASE::"To-do" then
        "To-do No." := Task."No.";
      StartWizard2;
    END;

    [External]
    PROCEDURE StartWizard2@34();
    VAR
      InteractionTmplSetup@1000 : Record "Interaction Template Setup";
      Campaign@1001 : Record Campaign;
    BEGIN
      InteractionTmplSetup.GET;
      InteractionTmplSetup.TESTFIELD("Outg. Calls");

      "Wizard Step" := "Wizard Step"::"1";
      if Date = 0D then
        Date := TODAY;
      "Time of Interaction" := TIME;
      "Interaction Successful" := true;
      "Dial Contact" := true;

      if Campaign.GET(GETFILTER("Campaign No.")) then
        "Campaign Description" := Campaign.Description;
      "Wizard Contact Name" := GetContactName;

      INSERT;
      VALIDATE("Interaction Template Code",InteractionTmplSetup."Outg. Calls");
      if PAGE.RUNMODAL(PAGE::"Make Phone Call",Rec,"Contact Via") = ACTION::OK then;
    END;

    [External]
    PROCEDURE CheckPhoneCallStatus@25();
    BEGIN
      if "Wizard Step" = "Wizard Step"::"1" then begin
        if "Dial Contact" and ("Contact Via" = '') then
          ERROR(Text013);
        if Date = 0D then
          ErrorMessage(FIELDCAPTION(Date));
        if Description = '' then
          ErrorMessage(FIELDCAPTION(Description));
        if "Salesperson Code" = '' then
          ErrorMessage(FIELDCAPTION("Salesperson Code"));
      end;
    END;

    [Internal]
    PROCEDURE LogPhoneCall@23();
    VAR
      TempAttachment@1000 : TEMPORARY Record Attachment;
      SegLine@1001 : Record "Segment Line";
      SegManagement@1002 : Codeunit SegManagement;
    BEGIN
      "Attempt Failed" := not "Interaction Successful";

      SegManagement.LogInteraction(Rec,TempAttachment,TempInterLogEntryCommentLine,false,false);

      if SegLine.GET("Segment No.","Line No.") then begin
        SegLine.LOCKTABLE;
        SegLine."Contact Via" := "Contact Via";
        SegLine."Wizard Step" := SegLine."Wizard Step"::" ";
        SegLine.MODIFY;
      end;
    END;

    [External]
    PROCEDURE ShowComment@27();
    BEGIN
      PAGE.RUNMODAL(PAGE::"Inter. Log Entry Comment Sheet",TempInterLogEntryCommentLine);
    END;

    [External]
    PROCEDURE SetComments@53(VAR InterLogEntryCommentLine@1001 : Record "Inter. Log Entry Comment Line");
    BEGIN
      TempInterLogEntryCommentLine.DELETEALL;

      if InterLogEntryCommentLine.FINDSET then
        repeat
          TempInterLogEntryCommentLine := InterLogEntryCommentLine;
          TempInterLogEntryCommentLine.INSERT;
        until InterLogEntryCommentLine.NEXT = 0;
    END;

    [External]
    PROCEDURE IsHTMLAttachment@26() : Boolean;
    BEGIN
      if not TempAttachment.FIND then
        exit(false);
      exit(TempAttachment.IsHTML);
    END;

    [Internal]
    PROCEDURE PreviewHTMLContent@30();
    BEGIN
      TempAttachment.FIND;
      TempAttachment.ShowAttachment(Rec,'',true,false);
    END;

    [External]
    PROCEDURE LanguageCodeOnLookup@31();
    VAR
      SegInteractLanguage@1001 : Record "Segment Interaction Language";
      InteractionTmplLanguage@1000 : Record "Interaction Tmpl. Language";
    BEGIN
      TESTFIELD("Interaction Template Code");

      if SegHeader.GET("Segment No.") then begin
        SegInteractLanguage.SETRANGE("Segment No.","Segment No.");
        if UniqueAttachmentExists or
           ("Interaction Template Code" <> SegHeader."Interaction Template Code")
        then
          SegInteractLanguage.SETRANGE("Segment Line No.","Line No.")
        else
          SegInteractLanguage.SETRANGE("Segment Line No.",0);

        if PAGE.RUNMODAL(0,SegInteractLanguage) = ACTION::LookupOK then begin
          GET("Segment No.","Line No.");
          "Language Code" := SegInteractLanguage."Language Code";
          "Attachment No." := SegInteractLanguage."Attachment No.";
          Subject := SegInteractLanguage.Subject;
          MODIFY;
        end else
          GET("Segment No.","Line No.");
      end else begin  // Create Interaction
        InteractionTmplLanguage.SETRANGE("Interaction Template Code","Interaction Template Code");
        if PAGE.RUNMODAL(0,InteractionTmplLanguage) = ACTION::LookupOK then begin
          "Language Code" := InteractionTmplLanguage."Language Code";
          MODIFY;
        end;
        SetInteractionAttachment;
      end;
    END;

    PROCEDURE FilterContactCompanyOpportunities@29(VAR Opportunity@1000 : Record Opportunity);
    BEGIN
      Opportunity.RESET;
      Opportunity.SETRANGE(Closed,false);
      if "Salesperson Code" <> '' then
        Opportunity.SETRANGE("Salesperson Code","Salesperson Code");
      Opportunity.SETFILTER("Contact Company No.","Contact Company No.");
      if "Opportunity No." <> '' then begin
        Opportunity.SETRANGE("No.","Opportunity No.");
        if Opportunity.FINDFIRST then;
        Opportunity.SETRANGE("No.");
      end;
    END;

    LOCAL PROCEDURE FindSalespersonByUserEmail@35() : Code[10];
    VAR
      User@1002 : Record User;
      Salesperson@1003 : Record "Salesperson/Purchaser";
      Email@1001 : Text[250];
    BEGIN
      User.SETRANGE("User Name",USERID);
      if User.FINDFIRST then
        Email := User."Authentication Email";

      if Email <> '' then begin
        Salesperson.SETRANGE("E-Mail",Email);
        if Salesperson.COUNT = 1 then begin
          Salesperson.FINDFIRST;
          "Salesperson Code" := Salesperson.Code;
        end;
      end;
      exit("Salesperson Code");
    END;

    PROCEDURE ExportODataFields@36();
    VAR
      TenantWebService@1001 : Record "Tenant Web Service";
      ODataFieldsExport@1002 : Page "OData Fields Export";
      RecRef@1000 : RecordRef;
    BEGIN
      TenantWebService.SETRANGE("Object Type",TenantWebService."Object Type"::Query);
      TenantWebService.SETRANGE("Object ID",QUERY::"Segment Lines");
      TenantWebService.FINDFIRST;

      RecRef.OPEN(DATABASE::"Segment Line");
      RecRef.SETVIEW(GETVIEW);

      ODataFieldsExport.SetExportData(TenantWebService,RecRef);
      ODataFieldsExport.RUNMODAL;
    END;

    LOCAL PROCEDURE EmailDraftLogging@40() : Boolean;
    VAR
      InteractionMgt@1000 : Codeunit "Interaction Mgt.";
    BEGIN
      exit(InteractionMgt.GetEmailDraftLogging);
    END;

    LOCAL PROCEDURE GetEmailDraftSubject@44() : Text[50];
    BEGIN
      exit(
        COPYSTR(
          STRSUBSTNO('%1 - %2',"Document Type","Document No."),
          1,
          MAXSTRLEN(Subject)));
    END;

    BEGIN
    END.
  }
}

