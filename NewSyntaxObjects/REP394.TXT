OBJECT Report 394 Suggest Employee Payments
{
  OBJECT-PROPERTIES
  {
    Date=20171006D;
    Time=120000T;
    Version List=NAVW111.0;
  }
  PROPERTIES
  {
    CaptionML=ENU=Suggest Employee Payments;
    ProcessingOnly=true;
    OnPreReport=BEGIN
                  CompanyInformation.GET;
                  TempEmployeeLedgerEntry.DELETEALL;
                  ShowPostingDateWarning := false;
                END;

    OnPostReport=BEGIN
                   COMMIT;
                   if not TempEmployeeLedgerEntry.ISEMPTY then
                     if CONFIRM(UnprocessedEntriesQst) then
                       PAGE.RUNMODAL(0,TempEmployeeLedgerEntry);
                 END;

  }
  DATASET
  {
    { 3182;    ;DataItem;Employee            ;
               DataItemTable=Employee;
               DataItemTableView=SORTING("No.");
               OnPreDataItem=BEGIN
                               if PostingDate = 0D then
                                 ERROR(PostingDateRequiredErr);

                               BankPmtType := GenJnlLine2."Bank Payment Type";
                               BalAccType := GenJnlLine2."Bal. Account Type";
                               BalAccNo := GenJnlLine2."Bal. Account No.";
                               GenJnlLineInserted := false;
                               MessageText := '';

                               if ((BankPmtType = BankPmtType::" ") or
                                   SummarizePerEmpl) and
                                  (NextDocNo = '')
                               then
                                 ERROR(StartingDocNoErr);

                               if ((BankPmtType = BankPmtType::"Manual Check") and
                                   not SummarizePerEmpl and
                                   not DocNoPerLine)
                               then
                                 ERROR(ManualCheckErr);

                               Empl2.COPYFILTERS(Employee);

                               OriginalAmtAvailable := AmountAvailable;

                               Window.OPEN(ProcessingEmployeesMsg);

                               SelectedDim.SETRANGE("User ID",USERID);
                               SelectedDim.SETRANGE("Object Type",3);
                               SelectedDim.SETRANGE("Object ID",REPORT::"Suggest Employee Payments");
                               SummarizePerDim := SelectedDim.FIND('-') and SummarizePerEmpl;

                               NextEntryNo := 1;
                             END;

               OnAfterGetRecord=BEGIN
                                  CLEAR(EmployeeBalance);
                                  CALCFIELDS(Balance);
                                  EmployeeBalance := Balance;

                                  if StopPayments then
                                    CurrReport.BREAK;
                                  Window.UPDATE(1,"No.");
                                  if EmployeeBalance > 0 then begin
                                    GetEmplLedgEntries(true);
                                    GetEmplLedgEntries(false);
                                    CheckAmounts;
                                    ClearNegative;
                                  end;
                                END;

               OnPostDataItem=BEGIN
                                if FINDSET then
                                  repeat
                                    ClearNegative;
                                  until NEXT = 0;

                                DimSetEntry.LOCKTABLE;
                                GenJnlLine.LOCKTABLE;
                                GenJnlTemplate.GET(GenJnlLine."Journal Template Name");
                                GenJnlBatch.GET(GenJnlLine."Journal Template Name",GenJnlLine."Journal Batch Name");
                                GenJnlLine.SETRANGE("Journal Template Name",GenJnlLine."Journal Template Name");
                                GenJnlLine.SETRANGE("Journal Batch Name",GenJnlLine."Journal Batch Name");
                                if GenJnlLine.FINDLAST then begin
                                  LastLineNo := GenJnlLine."Line No.";
                                  GenJnlLine.INIT;
                                end;

                                Window2.OPEN(InsertingJournalLinesMsg);

                                TempPayableEmployeeLedgerEntry.RESET;
                                MakeGenJnlLines;
                                TempPayableEmployeeLedgerEntry.RESET;
                                MakeGenJnlLines;
                                TempPayableEmployeeLedgerEntry.RESET;
                                TempPayableEmployeeLedgerEntry.DELETEALL;

                                Window2.CLOSE;
                                Window.CLOSE;
                                ShowMessage(MessageText);
                              END;

               ReqFilterFields="No." }

  }
  REQUESTPAGE
  {
    PROPERTIES
    {
      SaveValues=true;
      OnInit=BEGIN
               SummarizePerDimTextEnable := true;
               SkipExportedPayments := true;
             END;

      OnOpenPage=BEGIN
                   PostingDate := WORKDATE;
                   ValidatePostingDate;
                   SetDefaults;
                 END;

    }
    CONTROLS
    {
      { 1900000001;0;Container;
                  Name=Container1900000001;
                  ContainerType=ContentArea }

      { 1900000002;1;Group  ;
                  Name=Options;
                  CaptionML=ENU=Options;
                  GroupType=Group }

      { 4   ;2   ;Group     ;
                  Name=Find Payments;
                  CaptionML=ENU=Find Payments;
                  GroupType=Group }

      { 11  ;3   ;Field     ;
                  Name=Available Amount (LCY);
                  CaptionML=ENU=Available Amount (LCY);
                  ToolTipML=ENU=Specifies a maximum amount (in LCY) that is available for payments.;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=AmountAvailable;
                  Importance=Additional }

      { 13  ;3   ;Field     ;
                  Name=SkipExportedPayments;
                  CaptionML=ENU=Skip Exported Payments;
                  ToolTipML=ENU=Specifies if you do not want the batch job to insert payment journal lines for documents for which payments have already been exported to a bank file.;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=SkipExportedPayments;
                  Importance=Additional }

      { 7   ;2   ;Group     ;
                  Name=Summarize Results;
                  CaptionML=ENU=Summarize Results;
                  GroupType=Group }

      { 6   ;3   ;Field     ;
                  Name=SummarizePerEmployee;
                  CaptionML=ENU=Summarize per Employee;
                  ToolTipML=ENU=Specifies if you want the batch job to make one line per employee;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=SummarizePerEmpl }

      { 17  ;3   ;Field     ;
                  Name=SummarizePerDimText;
                  CaptionML=ENU=By Dimension;
                  ToolTipML=ENU=Specifies the dimensions that you want the batch job to consider.;
                  ApplicationArea=#Suite;
                  SourceExpr=SummarizePerDimText;
                  Importance=Additional;
                  Enabled=SummarizePerDimTextEnable;
                  Editable=FALSE;
                  OnAssistEdit=VAR
                                 DimSelectionBuf@1001 : Record "Dimension Selection Buffer";
                               BEGIN
                                 DimSelectionBuf.SetDimSelectionMultiple(3,REPORT::"Suggest Employee Payments",SummarizePerDimText);
                               END;
                                }

      { 8   ;2   ;Group     ;
                  Name=Fill in Journal Lines;
                  CaptionML=ENU=Fill in Journal Lines;
                  GroupType=Group }

      { 5   ;3   ;Field     ;
                  Name=PostingDate;
                  CaptionML=ENU=Posting Date;
                  ToolTipML=ENU=Specifies the date for the posting of this batch job. By default, the working date is entered, but you can change it.;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=PostingDate;
                  Importance=Promoted;
                  OnValidate=BEGIN
                               ValidatePostingDate;
                             END;
                              }

      { 9   ;3   ;Field     ;
                  Name=StartingDocumentNo;
                  CaptionML=ENU=Starting Document No.;
                  ToolTipML=ENU=Specifies the next available number in the number series for the journal batch that is linked to the payment journal. When you run the batch job, this is the document number that appears on the first payment journal line. You can also fill in this field manually.;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=NextDocNo;
                  OnValidate=VAR
                               TextManagement@1000 : Codeunit TextManagement;
                             BEGIN
                               if NextDocNo <> '' then
                                 TextManagement.EvaluateIncStr(NextDocNo,StartingDocumentNoErr);
                             END;
                              }

      { 18  ;3   ;Field     ;
                  Name=NewDocNoPerLine;
                  CaptionML=ENU=New Doc. No. per Line;
                  ToolTipML=ENU=Specifies if you want the batch job to fill in the payment journal lines with consecutive document numbers, starting with the document number specified in the Starting Document No. field.;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=DocNoPerLine;
                  Importance=Additional }

      { 10  ;3   ;Field     ;
                  Name=BalAccountType;
                  CaptionML=ENU=Bal. Account Type;
                  ToolTipML=ENU=Specifies the balancing account type that payments on the payment journal are posted to.;
                  OptionCaptionML=ENU=G/L Account,,,Bank Account;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=GenJnlLine2."Bal. Account Type";
                  Importance=Additional;
                  OnValidate=BEGIN
                               GenJnlLine2."Bal. Account No." := '';
                             END;
                              }

      { 12  ;3   ;Field     ;
                  Name=BalAccountNo;
                  CaptionML=ENU=Bal. Account No.;
                  ToolTipML=ENU=Specifies the balancing account number that payments on the payment journal are posted to.;
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=GenJnlLine2."Bal. Account No.";
                  Importance=Additional;
                  OnValidate=BEGIN
                               if GenJnlLine2."Bal. Account No." <> '' then
                                 case GenJnlLine2."Bal. Account Type" of
                                   GenJnlLine2."Bal. Account Type"::"G/L Account":
                                     GLAcc.GET(GenJnlLine2."Bal. Account No.");
                                   GenJnlLine2."Bal. Account Type"::Customer,
                                   GenJnlLine2."Bal. Account Type"::Vendor,
                                   GenJnlLine2."Bal. Account Type"::Employee:
                                     ERROR(AccountTypeErr,GenJnlLine2.FIELDCAPTION("Bal. Account Type"));
                                   GenJnlLine2."Bal. Account Type"::"Bank Account":
                                     BankAcc.GET(GenJnlLine2."Bal. Account No.");
                                 end;
                             END;

                  OnLookup=BEGIN
                             case GenJnlLine2."Bal. Account Type" of
                               GenJnlLine2."Bal. Account Type"::"G/L Account":
                                 if PAGE.RUNMODAL(0,GLAcc) = ACTION::LookupOK then
                                   GenJnlLine2."Bal. Account No." := GLAcc."No.";
                               GenJnlLine2."Bal. Account Type"::Customer,
                               GenJnlLine2."Bal. Account Type"::Vendor,
                               GenJnlLine2."Bal. Account Type"::Employee:
                                 ERROR(AccountTypeErr,GenJnlLine2.FIELDCAPTION("Bal. Account Type"));
                               GenJnlLine2."Bal. Account Type"::"Bank Account":
                                 if PAGE.RUNMODAL(0,BankAcc) = ACTION::LookupOK then
                                   GenJnlLine2."Bal. Account No." := BankAcc."No.";
                             end;
                           END;
                            }

      { 14  ;3   ;Field     ;
                  Name=BankPaymentType;
                  CaptionML=ENU=Bank Payment Type;
                  ToolTipML=ENU=Specifies the check type to be used, if you use Bank Account as the balancing account type.;
                  OptionCaptionML=ENU=" ,Computer Check,Manual Check";
                  ApplicationArea=#Basic,#Suite;
                  SourceExpr=GenJnlLine2."Bank Payment Type";
                  Importance=Additional;
                  OnValidate=BEGIN
                               if (GenJnlLine2."Bal. Account Type" <> GenJnlLine2."Bal. Account Type"::"Bank Account") and
                                  (GenJnlLine2."Bank Payment Type" > 0)
                               then
                                 ERROR(BankPaymentTypeErr);
                             END;
                              }

    }
  }
  LABELS
  {
  }
  CODE
  {
    VAR
      PostingDateRequiredErr@1001 : TextConst 'ENU=In the Posting Date field, specify the date that will be used as the posting date for the journal entries.';
      StartingDocNoErr@1002 : TextConst 'ENU=In the Starting Document No. field, specify the first document number to be used.';
      ProcessingEmployeesMsg@1006 : TextConst '@@@=#1########## is for the progress dialog. Don''t translate that part of the string;ENU=Processing employees     #1##########';
      InsertingJournalLinesMsg@1008 : TextConst '@@@=#1########## is for the progress dialog. Don''t translate that part of the string;ENU=Inserting payment journal lines #1##########';
      AccountTypeErr@1009 : TextConst '@@@=%1 - balancing account type;ENU=%1 must be G/L Account or Bank Account.';
      BankPaymentTypeErr@1010 : TextConst 'ENU=Bank Payment Type field must be filled only when Bal. Account Type is set to Bank Account.';
      ManualCheckErr@1017 : TextConst 'ENU=If bank payment type is set to Manual Check, and you have not selected the Summarize per Employee field,\ then you must select the New Doc. No. per Line.';
      EmployeePaymentLinesCreatedTxt@1022 : TextConst 'ENU=You have created suggested employee payment lines.';
      Empl2@1023 : Record Employee;
      GenJnlTemplate@1024 : Record "Gen. Journal Template";
      GenJnlBatch@1025 : Record "Gen. Journal Batch";
      GenJnlLine@1026 : Record "Gen. Journal Line";
      DimSetEntry@1027 : Record "Dimension Set Entry";
      GenJnlLine2@1028 : Record "Gen. Journal Line";
      EmployeeLedgerEntry@1029 : Record "Employee Ledger Entry";
      GLAcc@1030 : Record "G/L Account";
      BankAcc@1031 : Record "Bank Account";
      TempPayableEmployeeLedgerEntry@1032 : TEMPORARY Record "Payable Employee Ledger Entry";
      CompanyInformation@1062 : Record "Company Information";
      TempEmplPaymentBuffer@1033 : TEMPORARY Record "Employee Payment Buffer";
      OldTempEmplPaymentBuffer@1034 : TEMPORARY Record "Employee Payment Buffer";
      SelectedDim@1035 : Record "Selected Dimension";
      TempEmployeeLedgerEntry@1102601000 : TEMPORARY Record "Employee Ledger Entry";
      NoSeriesMgt@1036 : Codeunit NoSeriesManagement;
      DimMgt@1038 : Codeunit DimensionManagement;
      DimBufMgt@1018 : Codeunit "Dimension Buffer Management";
      Window@1039 : Dialog;
      Window2@1004 : Dialog;
      PostingDate@1041 : Date;
      NextDocNo@1043 : Code[20];
      AmountAvailable@1044 : Decimal;
      OriginalAmtAvailable@1045 : Decimal;
      SummarizePerEmpl@1047 : Boolean;
      SummarizePerDim@1048 : Boolean;
      SummarizePerDimText@1049 : Text[250];
      LastLineNo@1051 : Integer;
      NextEntryNo@1052 : Integer;
      StopPayments@1053 : Boolean;
      DocNoPerLine@1054 : Boolean;
      BankPmtType@1055 : '" ","Computer Check","Manual Check"';
      BalAccType@1056 : '"G/L Account",Customer,Vendor,"Bank Account","Fixed Asset","IC Partner",Employee';
      BalAccNo@1057 : Code[20];
      MessageText@1058 : Text;
      GenJnlLineInserted@1059 : Boolean;
      UnprocessedEntriesQst@1102601001 : TextConst 'ENU=There are one or more entries for which no payment suggestions have been made because the posting dates of the entries are later than the requested posting date. Do you want to see the entries?';
      SummarizePerDimTextEnable@19039578 : Boolean INDATASET;
      ShowPostingDateWarning@1119 : Boolean;
      EmployeeBalance@1065 : Decimal;
      ReplacePostingDateMsg@1064 : TextConst 'ENU=For one or more entries, the requested posting date is before the work date.\\These posting dates will use the work date.';
      SkipExportedPayments@1019 : Boolean;
      StartingDocumentNoErr@1012 : TextConst 'ENU=Starting Document No.';
      UnsupportedCurrencyErr@1007 : TextConst 'ENU=The balancing bank account must have local currency.';

    PROCEDURE SetGenJnlLine@1(NewGenJnlLine@1000 : Record "Gen. Journal Line");
    BEGIN
      GenJnlLine := NewGenJnlLine;
    END;

    LOCAL PROCEDURE ValidatePostingDate@7();
    BEGIN
      GenJnlBatch.GET(GenJnlLine."Journal Template Name",GenJnlLine."Journal Batch Name");
      if GenJnlBatch."No. Series" = '' then
        NextDocNo := ''
      else begin
        NextDocNo := NoSeriesMgt.GetNextNo(GenJnlBatch."No. Series",PostingDate,false);
        CLEAR(NoSeriesMgt);
      end;
    END;

    PROCEDURE InitializeRequest@3(NewAvailableAmount@1002 : Decimal;NewSkipExportedPayments@1009 : Boolean;NewPostingDate@1003 : Date;NewStartDocNo@1004 : Code[20];NewSummarizePerEmpl@1005 : Boolean;BalAccType@1006 : '"G/L Account",Customer,Vendor,"Bank Account","Fixed Asset","IC Partner",Employee';BalAccNo@1007 : Code[20];BankPmtType@1008 : '" ","Computer Check","Manual Check"');
    BEGIN
      AmountAvailable := NewAvailableAmount;
      SkipExportedPayments := NewSkipExportedPayments;
      PostingDate := NewPostingDate;
      NextDocNo := NewStartDocNo;
      SummarizePerEmpl := NewSummarizePerEmpl;
      GenJnlLine2."Bal. Account Type" := BalAccType;
      GenJnlLine2."Bal. Account No." := BalAccNo;
      GenJnlLine2."Bank Payment Type" := BankPmtType;
    END;

    LOCAL PROCEDURE GetEmplLedgEntries@13(Positive@1000 : Boolean);
    BEGIN
      EmployeeLedgerEntry.RESET;
      EmployeeLedgerEntry.SETCURRENTKEY("Employee No.",Open,Positive);
      EmployeeLedgerEntry.SETRANGE("Employee No.",Employee."No.");
      EmployeeLedgerEntry.SETRANGE(Open,true);
      EmployeeLedgerEntry.SETRANGE(Positive,Positive);
      EmployeeLedgerEntry.SETRANGE("Applies-to ID",'');

      if SkipExportedPayments then
        EmployeeLedgerEntry.SETRANGE("Exported to Payment File",false);
      EmployeeLedgerEntry.SETFILTER("Global Dimension 1 Code",Employee.GETFILTER("Global Dimension 1 Filter"));
      EmployeeLedgerEntry.SETFILTER("Global Dimension 2 Code",Employee.GETFILTER("Global Dimension 2 Filter"));

      if EmployeeLedgerEntry.FINDSET then
        repeat
          SaveAmount;
        until EmployeeLedgerEntry.NEXT = 0;
    END;

    LOCAL PROCEDURE SaveAmount@6();
    BEGIN
      with GenJnlLine do begin
        INIT;
        VALIDATE("Posting Date",PostingDate);
        "Document Type" := "Document Type"::Payment;
        "Account Type" := "Account Type"::Employee;
        Empl2.GET(EmployeeLedgerEntry."Employee No.");
        Description := COPYSTR(Empl2.FullName,1,MAXSTRLEN(Description));
        "Posting Group" := Empl2."Employee Posting Group";
        "Salespers./Purch. Code" := Empl2."Salespers./Purch. Code";
        VALIDATE("Bill-to/Pay-to No.","Account No.");
        VALIDATE("Sell-to/Buy-from No.","Account No.");
        "Gen. Posting Type" := 0;
        "Gen. Prod. Posting Group" := '';
        "Gen. Bus. Posting Group" := '';
        "VAT Bus. Posting Group" := '';
        "VAT Prod. Posting Group" := '';
        VALIDATE("Currency Code",EmployeeLedgerEntry."Currency Code");
        EmployeeLedgerEntry.CALCFIELDS("Remaining Amount");
        Amount := -EmployeeLedgerEntry."Remaining Amount";
        VALIDATE(Amount);
      end;

      TempPayableEmployeeLedgerEntry."Employee No." := EmployeeLedgerEntry."Employee No.";
      TempPayableEmployeeLedgerEntry."Entry No." := NextEntryNo;
      TempPayableEmployeeLedgerEntry."Employee Ledg. Entry No." := EmployeeLedgerEntry."Entry No.";
      TempPayableEmployeeLedgerEntry.Amount := GenJnlLine.Amount;
      TempPayableEmployeeLedgerEntry.Positive := (TempPayableEmployeeLedgerEntry.Amount > 0);
      TempPayableEmployeeLedgerEntry."Currency Code" := EmployeeLedgerEntry."Currency Code";
      TempPayableEmployeeLedgerEntry.INSERT;
      NextEntryNo := NextEntryNo + 1;
    END;

    LOCAL PROCEDURE CheckAmounts@10();
    VAR
      CurrencyBalance@1001 : Decimal;
      PrevCurrency@1002 : Code[10];
    BEGIN
      TempPayableEmployeeLedgerEntry.SETRANGE("Employee No.",Employee."No.");

      if TempPayableEmployeeLedgerEntry.FIND('-') then begin
        repeat
          if TempPayableEmployeeLedgerEntry."Currency Code" <> PrevCurrency then begin
            if CurrencyBalance > 0 then
              AmountAvailable := AmountAvailable - CurrencyBalance;
            CurrencyBalance := 0;
            PrevCurrency := TempPayableEmployeeLedgerEntry."Currency Code";
          end;
          if (OriginalAmtAvailable = 0) or
             (AmountAvailable >= CurrencyBalance + TempPayableEmployeeLedgerEntry.Amount)
          then
            CurrencyBalance := CurrencyBalance + TempPayableEmployeeLedgerEntry.Amount
          else
            TempPayableEmployeeLedgerEntry.DELETE;
        until TempPayableEmployeeLedgerEntry.NEXT = 0;
        if OriginalAmtAvailable > 0 then
          AmountAvailable := AmountAvailable - CurrencyBalance;
        if (OriginalAmtAvailable > 0) and (AmountAvailable <= 0) then
          StopPayments := true;
      end;
      TempPayableEmployeeLedgerEntry.RESET;
    END;

    LOCAL PROCEDURE MakeGenJnlLines@2();
    VAR
      RemainingAmtAvailable@1008 : Decimal;
    BEGIN
      TempEmplPaymentBuffer.RESET;
      TempEmplPaymentBuffer.DELETEALL;

      if BalAccType = BalAccType::"Bank Account" then
        CheckCurrencies(BalAccType,BalAccNo);

      if OriginalAmtAvailable <> 0 then begin
        RemainingAmtAvailable := OriginalAmtAvailable;
        RemovePaymentsAboveLimit(TempPayableEmployeeLedgerEntry,RemainingAmtAvailable);
      end;

      CopyEmployeeLedgerEntriesToTempEmplPaymentBuffer(RemainingAmtAvailable);
      CopyTempEmpPaymentBuffersToGenJnlLines;
    END;

    LOCAL PROCEDURE CopyEmployeeLedgerEntriesToTempEmplPaymentBuffer@21(RemainingAmtAvailable@1001 : Decimal);
    VAR
      DimBuf@1000 : Record "Dimension Buffer";
    BEGIN
      if TempPayableEmployeeLedgerEntry.FIND('-') then
        repeat
          TempPayableEmployeeLedgerEntry.SETRANGE("Employee No.",TempPayableEmployeeLedgerEntry."Employee No.");
          TempPayableEmployeeLedgerEntry.FIND('-');
          repeat
            EmployeeLedgerEntry.GET(TempPayableEmployeeLedgerEntry."Employee Ledg. Entry No.");

            TempEmplPaymentBuffer."Employee No." := EmployeeLedgerEntry."Employee No.";
            TempEmplPaymentBuffer."Currency Code" := EmployeeLedgerEntry."Currency Code";
            TempEmplPaymentBuffer."Payment Method Code" := EmployeeLedgerEntry."Payment Method Code";
            TempEmplPaymentBuffer."Creditor No." := EmployeeLedgerEntry."Creditor No.";
            TempEmplPaymentBuffer."Payment Reference" := EmployeeLedgerEntry."Payment Reference";
            TempEmplPaymentBuffer."Exported to Payment File" := EmployeeLedgerEntry."Exported to Payment File";

            SetTempEmplPaymentBufferDims(DimBuf);

            EmployeeLedgerEntry.CALCFIELDS("Remaining Amount");

            if SummarizePerEmpl then begin
              TempEmplPaymentBuffer."Employee Ledg. Entry No." := 0;
              if TempEmplPaymentBuffer.FIND then begin
                TempEmplPaymentBuffer.Amount := TempEmplPaymentBuffer.Amount + TempPayableEmployeeLedgerEntry.Amount;
                TempEmplPaymentBuffer.MODIFY;
              end else begin
                TempEmplPaymentBuffer."Document No." := NextDocNo;
                NextDocNo := INCSTR(NextDocNo);
                TempEmplPaymentBuffer.Amount := TempPayableEmployeeLedgerEntry.Amount;
                Window2.UPDATE(1,EmployeeLedgerEntry."Employee No.");
                TempEmplPaymentBuffer.INSERT;
              end;
              EmployeeLedgerEntry."Applies-to ID" := TempEmplPaymentBuffer."Document No.";
            end else
              if not IsEntryAlreadyApplied(GenJnlLine,EmployeeLedgerEntry) then begin
                TempEmplPaymentBuffer."Employee Ledg. Entry Doc. Type" := EmployeeLedgerEntry."Document Type";
                TempEmplPaymentBuffer."Employee Ledg. Entry Doc. No." := EmployeeLedgerEntry."Document No.";
                TempEmplPaymentBuffer."Global Dimension 1 Code" := EmployeeLedgerEntry."Global Dimension 1 Code";
                TempEmplPaymentBuffer."Global Dimension 2 Code" := EmployeeLedgerEntry."Global Dimension 2 Code";
                TempEmplPaymentBuffer."Dimension Set ID" := EmployeeLedgerEntry."Dimension Set ID";
                TempEmplPaymentBuffer."Employee Ledg. Entry No." := EmployeeLedgerEntry."Entry No.";
                TempEmplPaymentBuffer.Amount := TempPayableEmployeeLedgerEntry.Amount;
                Window2.UPDATE(1,EmployeeLedgerEntry."Employee No.");
                TempEmplPaymentBuffer.INSERT;
              end;

            EmployeeLedgerEntry."Amount to Apply" := EmployeeLedgerEntry."Remaining Amount";
            CODEUNIT.RUN(CODEUNIT::"Empl. Entry-Edit",EmployeeLedgerEntry);

            TempPayableEmployeeLedgerEntry.DELETE;
            if OriginalAmtAvailable <> 0 then begin
              RemainingAmtAvailable := RemainingAmtAvailable - TempPayableEmployeeLedgerEntry.Amount;
              RemovePaymentsAboveLimit(TempPayableEmployeeLedgerEntry,RemainingAmtAvailable);
            end;

          until not TempPayableEmployeeLedgerEntry.FINDSET;
          TempPayableEmployeeLedgerEntry.DELETEALL;
          TempPayableEmployeeLedgerEntry.SETRANGE("Employee No.");
        until not TempPayableEmployeeLedgerEntry.FIND('-');
    END;

    LOCAL PROCEDURE CopyTempEmpPaymentBuffersToGenJnlLines@11();
    VAR
      Employee@1000 : Record Employee;
    BEGIN
      CLEAR(OldTempEmplPaymentBuffer);
      TempEmplPaymentBuffer.SETCURRENTKEY("Document No.");
      TempEmplPaymentBuffer.SETFILTER(
        "Employee Ledg. Entry Doc. Type",'<>%1&<>%2',TempEmplPaymentBuffer."Employee Ledg. Entry Doc. Type"::Refund,
        TempEmplPaymentBuffer."Employee Ledg. Entry Doc. Type"::Payment);
      if TempEmplPaymentBuffer.FINDSET then
        repeat
          with GenJnlLine do begin
            INIT;
            Window2.UPDATE(1,TempEmplPaymentBuffer."Employee No.");
            LastLineNo := LastLineNo + 10000;
            "Line No." := LastLineNo;
            "Document Type" := "Document Type"::Payment;
            "Posting No. Series" := GenJnlBatch."Posting No. Series";
            if SummarizePerEmpl then
              "Document No." := TempEmplPaymentBuffer."Document No."
            else
              if DocNoPerLine then begin
                if TempEmplPaymentBuffer.Amount < 0 then
                  "Document Type" := "Document Type"::Refund;

                "Document No." := NextDocNo;
                NextDocNo := INCSTR(NextDocNo);
              end else
                if (TempEmplPaymentBuffer."Employee No." = OldTempEmplPaymentBuffer."Employee No.") and
                   (TempEmplPaymentBuffer."Currency Code" = OldTempEmplPaymentBuffer."Currency Code")
                then
                  "Document No." := OldTempEmplPaymentBuffer."Document No."
                else begin
                  "Document No." := NextDocNo;
                  NextDocNo := INCSTR(NextDocNo);
                  OldTempEmplPaymentBuffer := TempEmplPaymentBuffer;
                  OldTempEmplPaymentBuffer."Document No." := "Document No.";
                end;
            "Account Type" := "Account Type"::Employee;
            SetHideValidation(true);
            VALIDATE("Posting Date",PostingDate);
            VALIDATE("Account No.",TempEmplPaymentBuffer."Employee No.");
            Employee.GET(TempEmplPaymentBuffer."Employee No.");

            "Bal. Account Type" := BalAccType;
            VALIDATE("Bal. Account No.",BalAccNo);
            VALIDATE("Currency Code",TempEmplPaymentBuffer."Currency Code");
            "Message to Recipient" := CompanyInformation.Name;
            "Bank Payment Type" := BankPmtType;
            if SummarizePerEmpl then
              "Applies-to ID" := "Document No.";
            Description := COPYSTR(Employee.FullName,1,MAXSTRLEN(Description));
            "Source Line No." := TempEmplPaymentBuffer."Employee Ledg. Entry No.";
            "Shortcut Dimension 1 Code" := TempEmplPaymentBuffer."Global Dimension 1 Code";
            "Shortcut Dimension 2 Code" := TempEmplPaymentBuffer."Global Dimension 2 Code";
            "Dimension Set ID" := TempEmplPaymentBuffer."Dimension Set ID";
            "Source Code" := GenJnlTemplate."Source Code";
            "Reason Code" := GenJnlBatch."Reason Code";
            VALIDATE(Amount,TempEmplPaymentBuffer.Amount);
            "Applies-to Doc. Type" := TempEmplPaymentBuffer."Employee Ledg. Entry Doc. Type";
            "Applies-to Doc. No." := TempEmplPaymentBuffer."Employee Ledg. Entry Doc. No.";
            "Payment Method Code" := TempEmplPaymentBuffer."Payment Method Code";
            "Creditor No." := COPYSTR(TempEmplPaymentBuffer."Creditor No.",1,MAXSTRLEN("Creditor No."));
            "Payment Reference" := COPYSTR(TempEmplPaymentBuffer."Payment Reference",1,MAXSTRLEN("Payment Reference"));
            "Exported to Payment File" := TempEmplPaymentBuffer."Exported to Payment File";
            "Applies-to Ext. Doc. No." := TempEmplPaymentBuffer."Applies-to Ext. Doc. No.";

            UpdateDimensions(GenJnlLine);
            INSERT;
            GenJnlLineInserted := true;
          end;
        until TempEmplPaymentBuffer.NEXT = 0;
    END;

    LOCAL PROCEDURE UpdateDimensions@17(VAR GenJnlLine@1005 : Record "Gen. Journal Line");
    VAR
      DimBuf@1002 : Record "Dimension Buffer";
      TempDimSetEntry@1001 : TEMPORARY Record "Dimension Set Entry";
      TempDimSetEntry2@1000 : TEMPORARY Record "Dimension Set Entry";
      DimVal@1004 : Record "Dimension Value";
      NewDimensionID@1003 : Integer;
      DimSetIDArr@1006 : ARRAY [10] OF Integer;
    BEGIN
      with GenJnlLine do begin
        NewDimensionID := "Dimension Set ID";
        if SummarizePerEmpl then begin
          DimBuf.RESET;
          DimBuf.DELETEALL;
          DimBufMgt.GetDimensions(TempEmplPaymentBuffer."Dimension Entry No.",DimBuf);
          if DimBuf.FINDSET then
            repeat
              DimVal.GET(DimBuf."Dimension Code",DimBuf."Dimension Value Code");
              TempDimSetEntry."Dimension Code" := DimBuf."Dimension Code";
              TempDimSetEntry."Dimension Value ID" := DimVal."Dimension Value ID";
              TempDimSetEntry."Dimension Value Code" := DimBuf."Dimension Value Code";
              TempDimSetEntry.INSERT;
            until DimBuf.NEXT = 0;
          NewDimensionID := DimMgt.GetDimensionSetID(TempDimSetEntry);
          "Dimension Set ID" := NewDimensionID;
        end;
        CreateDim(
          DimMgt.TypeToTableID1("Account Type"),"Account No.",
          DimMgt.TypeToTableID1("Bal. Account Type"),"Bal. Account No.",
          DATABASE::Job,"Job No.",
          DATABASE::"Salesperson/Purchaser","Salespers./Purch. Code",
          DATABASE::Campaign,"Campaign No.");
        if NewDimensionID <> "Dimension Set ID" then begin
          DimSetIDArr[2] := NewDimensionID;
          DimSetIDArr[1] := "Dimension Set ID";
          "Dimension Set ID" :=
            DimMgt.GetCombinedDimensionSetID(DimSetIDArr,"Shortcut Dimension 1 Code","Shortcut Dimension 2 Code");
        end;

        if SummarizePerEmpl then begin
          DimMgt.GetDimensionSet(TempDimSetEntry,"Dimension Set ID");
          if AdjustAgainstSelectedDim(TempDimSetEntry,TempDimSetEntry2) then
            "Dimension Set ID" := DimMgt.GetDimensionSetID(TempDimSetEntry2);
          DimMgt.UpdateGlobalDimFromDimSetID("Dimension Set ID","Shortcut Dimension 1 Code",
            "Shortcut Dimension 2 Code");
        end;
      end;
    END;

    LOCAL PROCEDURE ShowMessage@15(Text@1000 : Text);
    BEGIN
      if GenJnlLineInserted then begin
        if ShowPostingDateWarning then
          Text += ReplacePostingDateMsg;
        if Text <> '' then
          MESSAGE(Text);
      end;
    END;

    LOCAL PROCEDURE CheckCurrencies@4(BalAccType@1000 : '"G/L Account",Customer,Vendor,"Bank Account","Fixed Asset","IC Partner",Employee';BalAccNo@1001 : Code[20]);
    VAR
      BankAcc@1003 : Record "Bank Account";
    BEGIN
      if BalAccType = BalAccType::"Bank Account" then
        if BalAccNo <> '' then begin
          BankAcc.GET(BalAccNo);
          if BankAcc."Currency Code" <> '' then
            ERROR(UnsupportedCurrencyErr);

          MessageText := EmployeePaymentLinesCreatedTxt;
        end;
    END;

    LOCAL PROCEDURE ClearNegative@8();
    VAR
      TempCurrency@1000 : TEMPORARY Record Currency;
      TempPayableEmplLedgEntry2@1001 : TEMPORARY Record "Payable Employee Ledger Entry";
      CurrencyBalance@1002 : Decimal;
    BEGIN
      CLEAR(TempPayableEmployeeLedgerEntry);
      TempPayableEmployeeLedgerEntry.SETRANGE("Employee No.",Employee."No.");

      while TempPayableEmployeeLedgerEntry.NEXT <> 0 do begin
        TempCurrency.Code := TempPayableEmployeeLedgerEntry."Currency Code";
        CurrencyBalance := 0;
        if TempCurrency.INSERT then begin
          TempPayableEmplLedgEntry2 := TempPayableEmployeeLedgerEntry;
          TempPayableEmplLedgEntry2.SETRANGE("Currency Code",TempPayableEmployeeLedgerEntry."Currency Code");
          repeat
            CurrencyBalance := CurrencyBalance + TempPayableEmployeeLedgerEntry.Amount
          until TempPayableEmployeeLedgerEntry.NEXT = 0;
          if CurrencyBalance < 0 then begin
            TempPayableEmployeeLedgerEntry.DELETEALL;
            AmountAvailable += CurrencyBalance;
          end;
          TempPayableEmployeeLedgerEntry.SETRANGE("Currency Code");
          TempPayableEmployeeLedgerEntry := TempPayableEmplLedgEntry2;
        end;
      end;
      TempPayableEmployeeLedgerEntry.RESET;
    END;

    LOCAL PROCEDURE DimCodeIsInDimBuf@1101(DimCode@1111 : Code[20];DimBuf@1112 : Record "Dimension Buffer") : Boolean;
    BEGIN
      DimBuf.RESET;
      DimBuf.SETRANGE("Dimension Code",DimCode);
      exit(not DimBuf.ISEMPTY);
    END;

    LOCAL PROCEDURE RemovePaymentsAboveLimit@5(VAR PayableEmplLedgEntry@1000 : Record "Payable Employee Ledger Entry";RemainingAmtAvailable@1001 : Decimal);
    BEGIN
      PayableEmplLedgEntry.SETFILTER(Amount,'>%1',RemainingAmtAvailable);
      PayableEmplLedgEntry.DELETEALL;
      PayableEmplLedgEntry.SETRANGE(Amount);
    END;

    LOCAL PROCEDURE InsertDimBuf@9(VAR DimBuf@1004 : Record "Dimension Buffer";TableID@1000 : Integer;EntryNo@1001 : Integer;DimCode@1002 : Code[20];DimValue@1003 : Code[20]);
    BEGIN
      DimBuf.INIT;
      DimBuf."Table ID" := TableID;
      DimBuf."Entry No." := EntryNo;
      DimBuf."Dimension Code" := DimCode;
      DimBuf."Dimension Value Code" := DimValue;
      DimBuf.INSERT;
    END;

    LOCAL PROCEDURE AdjustAgainstSelectedDim@16(VAR TempDimSetEntry@1000 : TEMPORARY Record "Dimension Set Entry";VAR TempDimSetEntry2@1003 : TEMPORARY Record "Dimension Set Entry") : Boolean;
    BEGIN
      if SelectedDim.FINDSET then begin
        repeat
          TempDimSetEntry.SETRANGE("Dimension Code",SelectedDim."Dimension Code");
          if TempDimSetEntry.FINDFIRST then begin
            TempDimSetEntry2.TRANSFERFIELDS(TempDimSetEntry,true);
            TempDimSetEntry2.INSERT;
          end;
        until SelectedDim.NEXT = 0;
        exit(true);
      end;
      exit(false);
    END;

    LOCAL PROCEDURE SetTempEmplPaymentBufferDims@12(VAR DimBuf@1000 : Record "Dimension Buffer");
    VAR
      GLSetup@1003 : Record "General Ledger Setup";
      EntryNo@1001 : Integer;
    BEGIN
      if SummarizePerDim then begin
        DimBuf.RESET;
        DimBuf.DELETEALL;
        if SelectedDim.FIND('-') then
          repeat
            if DimSetEntry.GET(
                 EmployeeLedgerEntry."Dimension Set ID",SelectedDim."Dimension Code")
            then
              InsertDimBuf(DimBuf,DATABASE::"Dimension Buffer",0,DimSetEntry."Dimension Code",
                DimSetEntry."Dimension Value Code");
          until SelectedDim.NEXT = 0;
        EntryNo := DimBufMgt.FindDimensions(DimBuf);
        if EntryNo = 0 then
          EntryNo := DimBufMgt.InsertDimensions(DimBuf);
        TempEmplPaymentBuffer."Dimension Entry No." := EntryNo;
        if TempEmplPaymentBuffer."Dimension Entry No." <> 0 then begin
          GLSetup.GET;
          if DimCodeIsInDimBuf(GLSetup."Global Dimension 1 Code",DimBuf) then
            TempEmplPaymentBuffer."Global Dimension 1 Code" := EmployeeLedgerEntry."Global Dimension 1 Code"
          else
            TempEmplPaymentBuffer."Global Dimension 1 Code" := '';
          if DimCodeIsInDimBuf(GLSetup."Global Dimension 2 Code",DimBuf) then
            TempEmplPaymentBuffer."Global Dimension 2 Code" := EmployeeLedgerEntry."Global Dimension 2 Code"
          else
            TempEmplPaymentBuffer."Global Dimension 2 Code" := '';
        end else begin
          TempEmplPaymentBuffer."Global Dimension 1 Code" := '';
          TempEmplPaymentBuffer."Global Dimension 2 Code" := '';
        end;
        TempEmplPaymentBuffer."Dimension Set ID" := EmployeeLedgerEntry."Dimension Set ID";
      end else begin
        TempEmplPaymentBuffer."Dimension Entry No." := 0;
        TempEmplPaymentBuffer."Global Dimension 1 Code" := '';
        TempEmplPaymentBuffer."Global Dimension 2 Code" := '';
        TempEmplPaymentBuffer."Dimension Set ID" := 0;
      end;
    END;

    LOCAL PROCEDURE IsEntryAlreadyApplied@19(GenJnlLine3@1000 : Record "Gen. Journal Line";EmplLedgEntry2@1001 : Record "Employee Ledger Entry") : Boolean;
    VAR
      GenJnlLine4@1002 : Record "Gen. Journal Line";
    BEGIN
      GenJnlLine4.SETRANGE("Journal Template Name",GenJnlLine3."Journal Template Name");
      GenJnlLine4.SETRANGE("Journal Batch Name",GenJnlLine3."Journal Batch Name");
      GenJnlLine4.SETRANGE("Account Type",GenJnlLine4."Account Type"::Employee);
      GenJnlLine4.SETRANGE("Account No.",EmplLedgEntry2."Employee No.");
      GenJnlLine4.SETRANGE("Applies-to Doc. Type",EmplLedgEntry2."Document Type");
      GenJnlLine4.SETRANGE("Applies-to Doc. No.",EmplLedgEntry2."Document No.");
      exit(not GenJnlLine4.ISEMPTY);
    END;

    LOCAL PROCEDURE SetDefaults@14();
    BEGIN
      GenJnlBatch.GET(GenJnlLine."Journal Template Name",GenJnlLine."Journal Batch Name");
      GenJnlLine2."Bal. Account Type" := GenJnlBatch."Bal. Account Type";
      GenJnlLine2."Bal. Account No." := GenJnlBatch."Bal. Account No.";
    END;

    BEGIN
    END.
  }
  RDLDATA
  {
  }
}

